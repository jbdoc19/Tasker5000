 </style>
 </head>
 <body>
   <h1>ğŸ¯ Tasker 5000</h1>
 
   <section id="capture">
     <label>Task Name <input id="name" type="text" /></label>
-    <label>Importance (1â€“5) <select id="importance"></select></label>
-    <label>Urgency (1â€“5) <select id="urgency"></select></label>
-    <label>Dopamine â€“ Novelty (1â€“5) <select id="novelty"></select></label>
-    <label>Dopamine â€“ Interest (1â€“5) <select id="interest"></select></label>
+    <label>Importance (1â€“5)
+      <select id="importance">
+        <option value="1">1 â€” Minimal</option>
+        <option value="2">2</option>
+        <option value="3" selected>3 â€” Moderate</option>
+        <option value="4">4</option>
+        <option value="5">5 â€” Critical</option>
+      </select>
+    </label>
+    <label>Urgency (1â€“5)
+      <select id="urgency">
+        <option value="1">1 â€” No rush</option>
+        <option value="2">2</option>
+        <option value="3" selected>3 â€” Soon</option>
+        <option value="4">4</option>
+        <option value="5">5 â€” Immediate</option>
+      </select>
+    </label>
+    <label>Dopamine â€“ Novelty (1â€“5)
+      <select id="novelty">
+        <option value="1">1 â€” Familiar</option>
+        <option value="2">2</option>
+        <option value="3" selected>3 â€” Mixed</option>
+        <option value="4">4</option>
+        <option value="5">5 â€” Exciting</option>
+      </select>
+    </label>
+    <label>Dopamine â€“ Interest (1â€“5)
+      <select id="interest">
+        <option value="1">1 â€” Boring</option>
+        <option value="2">2</option>
+        <option value="3" selected>3 â€” Neutral</option>
+        <option value="4">4</option>
+        <option value="5">5 â€” Fascinating</option>
+      </select>
+    </label>
     <label>Dopamine â€“ External Pressure
   <select id="externalPressure">
     <option value="" disabled selected>â¬‡ï¸ Select external pressure</option>
     <option value="0">ğŸ§˜ No one is waiting</option>
     <option value="2">ğŸ“† Soft deadline</option>
     <option value="3">ğŸ§ Peer is waiting on me</option>
     <option value="5">ğŸ§  Boss is watching</option>
     <option value="5">ğŸš¨ Patient emergency</option>
   </select>
     </label>
-    <label>Time to Start (1â€“5) <select id="timeToStart"></select></label>
-    <label>Difficulty (1â€“5) <select id="difficulty"></select></label>
+    <label>Time to Start (1â€“5)
+      <select id="timeToStart">
+        <option value="1">1 â€” Requires prep</option>
+        <option value="2">2</option>
+        <option value="3" selected>3 â€” Ready soon</option>
+        <option value="4">4</option>
+        <option value="5">5 â€” Ready now</option>
+      </select>
+    </label>
+    <label>Difficulty (1â€“5)
+      <select id="difficulty">
+        <option value="1">1 â€” Easy</option>
+        <option value="2">2</option>
+        <option value="3" selected>3 â€” Manageable</option>
+        <option value="4">4</option>
+        <option value="5">5 â€” Very hard</option>
+      </select>
+    </label>
     <label>Optional Due Date
   <input type="date" id="dueDate" />
     </label>
     <div>
       <button onclick="addTask()">Add Task</button>
       <button onclick="saveAsTemplate()">Add as Template</button>
       <button onclick="startFocus()" id="startBtn" disabled>Get started</button>
       <button onclick="reset()">Reset</button>
       
     </div>
     <div id="templateSection" style="margin-top:1rem;">
   <h3>Templates</h3>
   <div id="templateButtons"></div>
     </div>
     
-    <details class="peek">
+    <details class="peek" open>
       <summary>ğŸ” Peek at tasks</summary>
       <div id="taskList"></div>
     </details>
     <div id="dueTodaySection" style="margin-top:1rem;">
   <h3>ğŸ—‚ï¸ Charts Due Today</h3>
   <div id="dueTodayList"></div>
     </div>
   </section>
 
   <section id="focus" class="hidden">
     <div class="focus" tabindex="0" aria-live="polite"></div>
     <div class="score" id="scoreView"></div>
     <div>
       <button onclick="completeTask()">Task complete</button>
       <button onclick="backToCapture()">Back to capture</button>
     </div>
   </section>
 
   <script>
 const $ = id => document.getElementById(id);
-
-// populate the numeric dropdowns
+const coerceNumber = (value, fallback = 0) => {
+  const parsed = Number(value);
+  return Number.isFinite(parsed) ? parsed : fallback;
+};
+const getScaleValue = (id, fallback = 3) => {
+  const el = $(id);
+  if (!el) return fallback;
+  const raw = el.value;
+  if (raw === null || raw === undefined || raw === "") return fallback;
+  const parsed = Number(raw);
+  return Number.isFinite(parsed) ? parsed : fallback;
+};
+
+// ensure the numeric dropdowns have usable defaults even if stored HTML was edited
 const selects = ["importance", "urgency", "novelty", "interest", "timeToStart", "difficulty"];
-selects.forEach(id => {
-  for (let i = 1; i <= 5; i++) {
-    const opt = document.createElement("option");
-    opt.value = opt.textContent = i;
-    $(id).appendChild(opt);
-  }
-});
+function ensureScaleControls() {
+  selects.forEach(id => {
+    const selectEl = $(id);
+    if (!selectEl) return;
+    if (selectEl.options.length === 0) {
+      for (let i = 1; i <= 5; i++) {
+        const opt = document.createElement("option");
+        opt.value = String(i);
+        opt.textContent = String(i);
+        selectEl.appendChild(opt);
+      }
+    }
+    if (!selectEl.value) {
+      selectEl.value = "3";
+    }
+  });
+}
 
 // Supabase / local storage setâ€‘up
 const MODE = localStorage.getItem("MODE") || "local";
 const SUPABASE_URL = localStorage.getItem("SUPABASE_URL");
 const SUPABASE_ANON_KEY = localStorage.getItem("SUPABASE_ANON_KEY");
 let supabase = null;
 
 let tasks = [];
 let templates = [];
 let focusQueue = [];
 
 function init() {
   if (MODE === "supabase" && SUPABASE_URL && SUPABASE_ANON_KEY) {
     const script = document.createElement('script');
     script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js';
     script.onload = async () => {
       supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
       const { data } = await supabase.from('tasks').select('*');
-      if (data) tasks = data;
+      tasks = Array.isArray(data) ? data.map(normalizeTask) : [];
       renderTemplates();
       updateUI();
     };
     document.head.appendChild(script);
   } else {
     const saved = localStorage.getItem("tasks");
-    if (saved) tasks = JSON.parse(saved);
+    tasks = saved ? JSON.parse(saved).map(normalizeTask) : [];
     const savedTemplates = localStorage.getItem("templates");
-    if (savedTemplates) templates = JSON.parse(savedTemplates);
+    templates = savedTemplates ? JSON.parse(savedTemplates) : [];
     renderTemplates();
     updateUI();
   }
 }
 
 function computePriority(t) {
   // if this task has sub-tasks, average their priorities
   if (Array.isArray(t.subTasks) && t.subTasks.length > 0) {
-    const total = t.subTasks.reduce((sum, s) => sum + s.priority, 0);
-    return total / t.subTasks.length;
+    const pending = t.subTasks.filter(s => !s.completed);
+    if (pending.length === 0) return 0;
+    const total = pending.reduce((sum, s) => sum + coerceNumber(s.priority, 0), 0);
+    return total / pending.length;
   }
 
   // original calculation
-  const dopamine     = t.novelty + t.interest;
-  const pressure     = t.externalPressure;
-  const friction     = (6 - t.timeToStart) + (6 - t.difficulty);
-  return (t.importance * 2)
-       + (t.urgency    * 2)
-       + (dopamine     * 2)
-       + (pressure     * 5)
-       + (friction     * 1.5);
+  const dopamine     = coerceNumber(t.novelty, 3) + coerceNumber(t.interest, 3);
+  const pressure     = coerceNumber(t.externalPressure, 0);
+  const friction     = (6 - coerceNumber(t.timeToStart, 3)) + (6 - coerceNumber(t.difficulty, 3));
+  return (coerceNumber(t.importance, 3) * 2)
+       + (coerceNumber(t.urgency, 3)    * 2)
+       + (dopamine                     * 2)
+       + (pressure                     * 5)
+       + (friction                     * 1.5);
+}
+
+function normalizeTask(raw) {
+  const task = { ...raw };
+  task.importance = coerceNumber(task.importance, 3);
+  task.urgency = coerceNumber(task.urgency, 3);
+  task.novelty = coerceNumber(task.novelty, 3);
+  task.interest = coerceNumber(task.interest, 3);
+  task.externalPressure = coerceNumber(task.externalPressure, 0);
+  task.timeToStart = coerceNumber(task.timeToStart, 3);
+  task.difficulty = coerceNumber(task.difficulty, 3);
+  const basePriority = computePriority({ ...task, subTasks: [] });
+  task.subTasks = Array.isArray(task.subTasks)
+    ? task.subTasks.map(sub => ({
+        ...sub,
+        completed: Boolean(sub && sub.completed),
+        priority: coerceNumber(sub && sub.priority, basePriority),
+      }))
+    : [];
+  task.priority = computePriority(task);
+  return task;
 }
 
 async function persist() {
   if (supabase) {
     for (const task of tasks) {
       await supabase.from('tasks').upsert(task, { onConflict: 'id' });
     }
   } else {
     localStorage.setItem("tasks", JSON.stringify(tasks));
   }
 }
 
 function addTask() {
   const name = $("name").value.trim();
   if (!name) return;
   const task = {
     id: Date.now().toString(),
     name,
-    importance: +$("importance").value,
-    urgency: +$("urgency").value,
-    novelty: +$("novelty").value,
-    interest: +$("interest").value,
-    externalPressure: +$("externalPressure").value,
-    timeToStart: +$("timeToStart").value,
-    difficulty: +$("difficulty").value,
+    importance: getScaleValue("importance"),
+    urgency: getScaleValue("urgency"),
+    novelty: getScaleValue("novelty"),
+    interest: getScaleValue("interest"),
+    externalPressure: getScaleValue("externalPressure", 0),
+    timeToStart: getScaleValue("timeToStart"),
+    difficulty: getScaleValue("difficulty"),
     dueDate: $("dueDate").value || null,
     completed: false,
     createdAt: new Date().toISOString(),
     addedAt: new Date().toISOString(),
     subTasks: [],
   };
   task.priority = computePriority(task);
   tasks.push(task);
   persist();
   $("name").value = "";
   updateUI();
 }
 
 function updateUI() {
   const taskList = $("taskList");
   taskList.innerHTML = "";
   const remaining = tasks.filter(t => !t.completed);
   $("startBtn").disabled = remaining.length === 0;
   tasks.sort((a, b) => b.priority - a.priority);
 
   for (const [i, t] of tasks.entries()) {
     const div = document.createElement("div");
     div.className = "task";
     const row = document.createElement("div");
     row.style.display = "flex";
@@ -206,165 +299,133 @@ function updateUI() {
     const delBtn = document.createElement("button");
     delBtn.textContent = "ğŸ—‘ï¸";
     delBtn.onclick = () => {
       if (!confirm("Delete this task?")) return;
       tasks.splice(i, 1);
       persist();
       updateUI();
     };
     row.appendChild(info);
     row.appendChild(delBtn);
     div.appendChild(row);
 
     if (t.addedAt) {
       const ts = document.createElement("div");
       ts.className = "score";
       ts.textContent = `Added: ${new Date(t.addedAt).toLocaleString()}`;
       div.appendChild(ts);
     }
     if (t.dueDate) {
       const dd = document.createElement("div");
       dd.className = "score";
       dd.textContent = `Due: ${t.dueDate}`;
       div.appendChild(dd);
     }
     // show subâ€‘task progress and list for all tasks
-if (t.subTasks && t.subTasks.length > 0) {
-  const completedCount = t.subTasks.filter(s => s.completed).length;
-  const progress = document.createElement("div");
-  progress.className = "score";
-  progress.textContent = `${completedCount}/${t.subTasks.length} steps done`;
-  div.appendChild(progress);
-
-  // render each subâ€‘task as a checkbox + label
-  t.subTasks.forEach((sub, subIndex) => {
-    const subRow = document.createElement("div");
-    subRow.style.display = "flex";
-    subRow.style.alignItems = "center";
-    subRow.style.marginLeft = "1rem";
-    const chk = document.createElement("input");
-    chk.type = "checkbox";
-    chk.checked = sub.completed;
-    chk.onchange = () => completeSubTask(i, subIndex);
-    const label = document.createElement("span");
-    label.textContent = sub.name;
-    label.style.marginLeft = "0.25rem";
-    subRow.appendChild(chk);
-    subRow.appendChild(label);
-    div.appendChild(subRow);
-  });
-}
-// add a button to create a new subâ€‘task for this task
-const addSubBtn = document.createElement("button");
-addSubBtn.textContent = "â• Step";
-addSubBtn.style.marginTop = "0.25rem";
-addSubBtn.onclick = () => addSubTask(i);
-div.appendChild(addSubBtn);
-
-    taskList.appendChild(div);
-  }
-
-// tasks due today
-const dueTodayList = $("dueTodayList");
-dueTodayList.innerHTML = "";
-const now = new Date();
-// adjust to local timezone so ISO date matches <input type="date">
-now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
-const today = now.toISOString().split("T")[0];
-
-tasks.forEach((task, idx) => {
-  if (task.dueDate === today && !task.completed) {
-    const wrap = document.createElement("div");
-    wrap.textContent = `${task.name} â€” due today`;
-
-    // show subâ€‘task progress and list if present
-    if (task.subTasks && task.subTasks.length > 0) {
-      const completedCount = task.subTasks.filter(s => s.completed).length;
+    if (t.subTasks && t.subTasks.length > 0) {
+      const completedCount = t.subTasks.filter(s => s.completed).length;
       const progress = document.createElement("div");
       progress.className = "score";
-      progress.textContent = `${completedCount}/${task.subTasks.length} steps done`;
-      wrap.appendChild(progress);
+      progress.textContent = `${completedCount}/${t.subTasks.length} steps done`;
+      div.appendChild(progress);
 
-      task.subTasks.forEach((sub, subIndex) => {
+      // render each subâ€‘task as a checkbox + label
+      t.subTasks.forEach((sub, subIndex) => {
         const subRow = document.createElement("div");
         subRow.style.display = "flex";
         subRow.style.alignItems = "center";
         subRow.style.marginLeft = "1rem";
         const chk = document.createElement("input");
         chk.type = "checkbox";
         chk.checked = sub.completed;
-        chk.onchange = () => completeSubTask(idx, subIndex);
+        chk.onchange = event => completeSubTask(i, subIndex, event.target.checked);
         const label = document.createElement("span");
         label.textContent = sub.name;
         label.style.marginLeft = "0.25rem";
         subRow.appendChild(chk);
         subRow.appendChild(label);
-        wrap.appendChild(subRow);
+        div.appendChild(subRow);
       });
     }
-
-    // add a button to create a new subâ€‘task for this due task
+    // add a button to create a new subâ€‘task for this task
     const addSubBtn = document.createElement("button");
-    addSubBtn.textContent = "â• Step";
+    addSubBtn.textContent = "â• Add sub-task";
     addSubBtn.style.marginTop = "0.25rem";
-    addSubBtn.onclick = () => addSubTask(idx);
-    wrap.appendChild(addSubBtn);
+    addSubBtn.onclick = () => addSubTask(i);
+    div.appendChild(addSubBtn);
 
-    dueTodayList.appendChild(wrap);
+    taskList.appendChild(div);
   }
-});
-
-
-
-// show sub-task progress and list
-if (t.subTasks && t.subTasks.length > 0) {
-  const completedCount = t.subTasks.filter(s => s.completed).length;
-  const progress = document.createElement("div");
-  progress.className = "score";
-  progress.textContent = `${completedCount}/${t.subTasks.length} steps done`;
-  div.appendChild(progress);
-
-  // render each sub-task as a checkbox + label
-  t.subTasks.forEach((s, subIndex) => {
-    const subRow = document.createElement("div");
-    subRow.style.display = "flex";
-    subRow.style.alignItems = "center";
-    subRow.style.marginLeft = "1rem";
-
-    const chk = document.createElement("input");
-    chk.type = "checkbox";
-    chk.checked = s.completed;
-    chk.onchange = () => completeSubTask(i, subIndex);
 
-    const label = document.createElement("span");
-    label.textContent = s.name;
-    label.style.marginLeft = "0.25rem";
-
-    subRow.appendChild(chk);
-    subRow.appendChild(label);
-    div.appendChild(subRow);
-  
+  // tasks due today
+  const dueTodayList = $("dueTodayList");
+  dueTodayList.innerHTML = "";
+  const now = new Date();
+  // adjust to local timezone so ISO date matches <input type="date">
+  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
+  const today = now.toISOString().split("T")[0];
+
+  tasks.forEach((task, idx) => {
+    if (task.dueDate === today && !task.completed) {
+      const wrap = document.createElement("div");
+      wrap.textContent = `${task.name} â€” due today`;
+
+      // show subâ€‘task progress and list if present
+      if (task.subTasks && task.subTasks.length > 0) {
+        const completedCount = task.subTasks.filter(s => s.completed).length;
+        const progress = document.createElement("div");
+        progress.className = "score";
+        progress.textContent = `${completedCount}/${task.subTasks.length} steps done`;
+        wrap.appendChild(progress);
+
+        task.subTasks.forEach((sub, subIndex) => {
+          const subRow = document.createElement("div");
+          subRow.style.display = "flex";
+          subRow.style.alignItems = "center";
+          subRow.style.marginLeft = "1rem";
+          const chk = document.createElement("input");
+          chk.type = "checkbox";
+          chk.checked = sub.completed;
+          chk.onchange = event => completeSubTask(idx, subIndex, event.target.checked);
+          const label = document.createElement("span");
+          label.textContent = sub.name;
+          label.style.marginLeft = "0.25rem";
+          subRow.appendChild(chk);
+          subRow.appendChild(label);
+          wrap.appendChild(subRow);
+        });
+      }
+
+      // add a button to create a new subâ€‘task for this due task
+      const addSubBtn = document.createElement("button");
+      addSubBtn.textContent = "â• Add sub-task";
+      addSubBtn.style.marginTop = "0.25rem";
+      addSubBtn.onclick = () => addSubTask(idx);
+      wrap.appendChild(addSubBtn);
+
+      dueTodayList.appendChild(wrap);
+    }
   });
 }
 
 // These functions are now global so button handlers can find them
 function startFocus() {
   $("capture").classList.add("hidden");
   $("focus").classList.remove("hidden");
   focusQueue = tasks.filter(t => !t.completed).sort((a, b) => b.priority - a.priority);
   showNextTask();
 }
 
 function showNextTask() {
   const display = document.querySelector(".focus");
   const scoreView = $("scoreView");
   if (focusQueue.length === 0) {
     display.textContent = "âœ… All tasks complete!";
     scoreView.textContent = "";
     return;
   }
   const current = focusQueue[0];
   display.textContent = current.name;
   scoreView.textContent = `Score: ${current.priority.toFixed(1)}`;
   display.focus();
 }
 
@@ -374,57 +435,57 @@ function completeTask() {
   persist();
   updateUI();
   focusQueue.shift();
   showNextTask();
 }
 
 function backToCapture() {
   $("focus").classList.add("hidden");
   $("capture").classList.remove("hidden");
   updateUI();
 }
 
 function reset() {
   if (!confirm("Clear all tasks?")) return;
   tasks = [];
   localStorage.removeItem("tasks");
   if (supabase) supabase.from("tasks").delete().neq("id", "");
   updateUI();
 }
 
 function saveAsTemplate() {
   const name = $("name").value.trim();
   if (!name) return alert("Task name is required");
   const template = {
     name,
-    importance: +$("importance").value,
-    urgency: +$("urgency").value,
-    novelty: +$("novelty").value,
-    interest: +$("interest").value,
-    externalPressure: +$("externalPressure").value,
-    timeToStart: +$("timeToStart").value,
-    difficulty: +$("difficulty").value
+    importance: getScaleValue("importance"),
+    urgency: getScaleValue("urgency"),
+    novelty: getScaleValue("novelty"),
+    interest: getScaleValue("interest"),
+    externalPressure: getScaleValue("externalPressure", 0),
+    timeToStart: getScaleValue("timeToStart"),
+    difficulty: getScaleValue("difficulty")
   };
   templates.push(template);
   localStorage.setItem("templates", JSON.stringify(templates));
   renderTemplates();
 }
 
 function renderTemplates() {
   const container = $("templateButtons");
   container.innerHTML = "";
   templates.forEach((t, i) => {
     const wrapper = document.createElement("div");
     const useBtn = document.createElement("button");
     useBtn.textContent = `ğŸ“‹ ${t.name}`;
     useBtn.onclick = () => {
       $("name").value = t.name;
       $("novelty").value = t.novelty;
       $("interest").value = t.interest;
       $("externalPressure").value = t.externalPressure;
       $("importance").value = t.importance;
       $("urgency").value = t.urgency;
       $("timeToStart").value = t.timeToStart;
       $("difficulty").value = t.difficulty;
     };
     const editBtn = document.createElement("button");
     editBtn.textContent = "âœï¸ Edit";
@@ -432,58 +493,76 @@ function renderTemplates() {
       const newName = prompt("Edit task name:", t.name);
       if (!newName) return;
       t.name = newName;
       localStorage.setItem("templates", JSON.stringify(templates));
       renderTemplates();
     };
     const deleteBtn = document.createElement("button");
     deleteBtn.textContent = "ğŸ—‘ï¸ Delete";
     deleteBtn.onclick = () => {
       if (!confirm("Delete this template?")) return;
       templates.splice(i, 1);
       localStorage.setItem("templates", JSON.stringify(templates));
       renderTemplates();
     };
     [useBtn, editBtn, deleteBtn].forEach(b => {
       b.style.marginRight = "0.3rem";
       b.style.fontSize = "0.9rem";
     });
     wrapper.appendChild(useBtn);
     wrapper.appendChild(editBtn);
     wrapper.appendChild(deleteBtn);
     container.appendChild(wrapper);
   });
 }
 
-window.addEventListener('DOMContentLoaded', init);
-    function addSubTask(taskIndex) {
+window.addEventListener('DOMContentLoaded', () => {
+  ensureScaleControls();
+  init();
+});
+
+function addSubTask(taskIndex) {
   const name = prompt("Sub-task name?");
   if (!name) return;
+  const trimmed = name.trim();
+  if (!trimmed) return;
+
   const parent = tasks[taskIndex];
+  if (!parent) return;
+
+  if (!Array.isArray(parent.subTasks)) {
+    parent.subTasks = [];
+  }
 
-  // create a sub-task; use parentâ€™s priority as a starting point
+  const basePriority = computePriority({ ...parent, subTasks: [] });
   const subTask = {
     id: Date.now().toString(),
-    name,
+    name: trimmed,
     completed: false,
-    priority: parent.priority
+    priority: basePriority
   };
 
   parent.subTasks.push(subTask);
+  parent.priority = computePriority(parent);
   persist();
   updateUI();
 }
 
-function completeSubTask(taskIndex, subIndex) {
+function completeSubTask(taskIndex, subIndex, isCompleted) {
   const parent = tasks[taskIndex];
-  parent.subTasks[subIndex].completed = true;
+  if (!parent || !Array.isArray(parent.subTasks)) return;
+  const subTask = parent.subTasks[subIndex];
+  if (!subTask) return;
+
+  subTask.completed = Boolean(isCompleted);
+  parent.priority = computePriority(parent);
   persist();
   updateUI();
 }
 
 </script>
   
 
 
   
 </body>
 </html> 
EOF
)
