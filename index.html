<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Focus</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h3 { color: #fff; }
    .billing-reminder {
      color: #ff6b6b;
      font-weight: 600;
      margin: 0.25rem 0 1rem;
      text-align: center;
    }
    .hidden { display: none; }
    label { display: block; margin-top: 0.5rem; }
    input[type="text"], select, input[type="date"], textarea {
      background: #222; color: #eee; border: 1px solid #555;
      padding: 0.5rem; width: 100%;
    }
    textarea { resize: vertical; }
    button {
      background: #333; color: #fff; border: none; padding: 0.6rem 1rem;
      margin: 0.5rem 0.25rem; cursor: pointer; border-radius: 4px;
    }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    .peek { background: #222; margin-top: 1rem; padding: 1rem; border-radius: 6px; max-width: 600px; }
    .peek summary { cursor: pointer; }
    .task { margin: 0.25rem 0; }
    .score { font-size: 0.8rem; color: #ccc; }
    .chart-age, .urgency-hint {
      display: block;
      margin-top: 0.25rem;
      color: #aaa;
      font-size: 0.85rem;
      max-width: 600px;
    }
    .focus { font-size: 1.5rem; margin: 1rem 0; }
    .category-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .category-filter button {
      background: #444;
      color: #fff;
      border: none;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .category-filter button.active {
      background: #666;
    }
    .category-progress {
      margin-top: 0.5rem;
      width: 100%;
      max-width: 600px;
    }
    .category-progress .line {
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    .category-progress .bar {
      background: #333;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
    }
    .category-progress .bar .fill {
      background: #0a84ff;
      height: 100%;
      display: block;
      width: 0%;
    }
    [aria-live] { outline: none; }
  </style>
</head>
<body>
  <h1>üéØ Task Focus</h1>
  <p id="billingReminder" class="billing-reminder"></p>

  <!-- Task entry form -->
  <section id="capture">
    <label for="name">Task Name
      <input id="name" type="text" placeholder="3/14 ‚Äì J.M. ‚Äì Complex Care Follow-Up (Resident)" autofocus />
    </label>
    <label for="taskCategory">Category
      <select id="taskCategory">
        <option value="General" selected>General</option>
        <option value="Admin">Admin</option>
        <option value="Chart">Chart</option>
        <option value="Inbox">Inbox</option>
        <option value="Calls">Calls</option>
        <option value="Teaching">Teaching</option>
        <option value="Personal">Personal</option>
      </select>
    </label>
    <label for="authorType">Chart Author
      <select id="authorType">
        <option value="attending" selected>Attending</option>
        <option value="resident">Resident</option>
      </select>
    </label>
    <label for="patientType" title="Complex = medically fragile, multi-specialty, or DME-dependent.">Patient Type
      <select id="patientType">
        <option value="Non-Complex" selected>Non-Complex</option>
        <option value="Complex">Complex</option>
      </select>
    </label>
    <label for="visitType" title="Determines estimated chart complexity and time to complete.">Visit Type
      <select id="visitType">
        <option value="Follow-Up" selected>Follow-Up</option>
        <option value="Establish Care">Establish Care</option>
        <option value="Well Child Visit">Well Child Visit</option>
        <option value="Acute Visit">Acute Visit</option>
      </select>
    </label>
    <label for="clinicSite" title="Same-day notes from St PJ‚Äôs or Craniofacial automatically rise to the top.">Clinic Site
      <select id="clinicSite">
        <option value="General Clinic" selected>General Clinic</option>
        <option value="St PJ‚Äôs Shelter">St PJ‚Äôs Shelter</option>
        <option value="Craniofacial Clinic">Craniofacial Clinic</option>
      </select>
    </label>
    <label for="dateOfService" title="Select the date of the encounter; defaults to today.">Date of Service
      <input type="date" id="dateOfService" />
    </label>
    <small id="chartAgeDisplay" class="chart-age"></small>
    <label for="importance">Importance (1‚Äì5) <select id="importance"></select></label>
    <label for="urgency">Urgency (1‚Äì5)
      <select id="urgency"></select>
    </label>
    <small id="urgencyHint" class="urgency-hint"></small>
    <label for="novelty">Novelty (1‚Äì5) <select id="novelty"></select></label>
    <label for="interest">Interest (1‚Äì5) <select id="interest"></select></label>
    <label for="externalPressure">External Pressure (1‚Äì5)
      <select id="externalPressure"></select>
    </label>
    <label for="timeToStart">Time to Start (1‚Äì5) <select id="timeToStart"></select></label>
    <label for="difficulty">Difficulty (1‚Äì5) <select id="difficulty"></select></label>
    <label for="dueDate" title="Optional specific target date; used for personal scheduling.">Due Date (Optional) <input type="date" id="dueDate" /></label>
    <label for="initialSubTasks">Subtasks
      <textarea id="initialSubTasks" rows="3" placeholder="One subtask per line."></textarea>
    </label>
    <div>
      <button id="addTaskBtn" onclick="addTask()">Add Task</button>
      <button id="saveUpdateBtn" class="hidden" onclick="saveTaskUpdate()">Save Update</button>
      <button id="cancelEditBtn" class="hidden" onclick="cancelEdit()">Cancel</button>
      <button onclick="saveAsTemplate()">Add as Template</button>
      <button onclick="startFocus()" id="startBtn" disabled>Get started</button>
      <button onclick="reset()">Reset</button>
    </div>
    <div id="templateSection" style="margin-top:1rem;">
      <h3>Templates</h3>
      <div id="templateButtons"></div>
    </div>
    <!-- Category filter bar -->
    <div id="categoryFilter" class="category-filter"></div>
    <!-- Progress per category -->
    <div id="categoryProgress" class="category-progress"></div>
    <details class="peek">
      <summary>üîç Peek at tasks</summary>
      <div id="taskList"></div>
    </details>
    <div id="dueTodaySection" style="margin-top:1rem;">
      <h3>üóÇÔ∏è Charts Due Today</h3>
      <div id="dueTodayList"></div>
    </div>
  </section>

  <!-- Focus mode -->
  <section id="focus" class="hidden">
    <div class="focus" tabindex="0" aria-live="polite"></div>
    <div class="score" id="scoreView"></div>
    <div id="subTaskView"></div>
    <div>
      <button onclick="completeTask()">Task complete</button>
      <button onclick="backToCapture()">Back to capture</button>
    </div>
  </section>

  <script>
  const $ = id => document.getElementById(id);

  const categories = ["General","Admin","Chart","Inbox","Calls","Teaching","Personal"];
  let activeCategory = "All";
  let derivedDaysSinceVisit = null;
  let urgencyAuto = true;

  const URGENCY_OPTIONS = [
    { value: 5, text: "5 ‚Äì Critical Billing Window or Immediate Patient Need" },
    { value: 4, text: "4 ‚Äì High Priority ‚Äì Near-Term Deadline" },
    { value: 3, text: "3 ‚Äì Moderate Priority ‚Äì Monthly Closure" },
    { value: 2, text: "2 ‚Äì Low Billing Value ‚Äì Already Overdue" },
    { value: 1, text: "1 ‚Äì Routine Follow-Up Work" }
  ];

  const PRESSURE_OPTIONS = [
    { value: 1, text: "1 ‚Äì Solo responsibility" },
    { value: 2, text: "2 ‚Äì Soft deadline / courtesy check" },
    { value: 3, text: "3 ‚Äì Peer or team waiting" },
    { value: 4, text: "4 ‚Äì Leadership expectation" },
    { value: 5, text: "5 ‚Äì Patient or compliance critical" }
  ];

  const NUMERIC_SCALE_FIELDS = ["importance","novelty","interest","timeToStart","difficulty"];

  function populateNumericSelect(id) {
    const sel = $(id);
    if (!sel) return;
    sel.innerHTML = "";
    for (let i = 1; i <= 5; i++) {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      sel.appendChild(opt);
    }
  }

  function populateUrgencySelect() {
    const sel = $("urgency");
    if (!sel) return;
    sel.innerHTML = "";
    URGENCY_OPTIONS.forEach(option => {
      const opt = document.createElement("option");
      opt.value = String(option.value);
      opt.textContent = option.text;
      sel.appendChild(opt);
    });
  }

  function populateExternalPressureSelect() {
    const sel = $("externalPressure");
    if (!sel) return;
    sel.innerHTML = "";
    PRESSURE_OPTIONS.forEach(option => {
      const opt = document.createElement("option");
      opt.value = String(option.value);
      opt.textContent = option.text;
      sel.appendChild(opt);
    });
  }

  function populateScales() {
    NUMERIC_SCALE_FIELDS.forEach(populateNumericSelect);
    populateUrgencySelect();
    populateExternalPressureSelect();
  }

  populateScales();

  function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  function calculateDaysSince(dateString) {
    if (!dateString) return null;
    const parsed = new Date(dateString + "T00:00:00");
    if (Number.isNaN(parsed.getTime())) return null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const diffMs = today.getTime() - parsed.getTime();
    return Math.floor(diffMs / (1000 * 60 * 60 * 24));
  }

  function getUrgencyDescriptor(value) {
    const option = URGENCY_OPTIONS.find(opt => Number(opt.value) === Number(value));
    return option ? option.text : null;
  }

  function getSuggestedUrgency(days) {
    if (days === null || days === undefined || Number.isNaN(days)) return 3;
    if (days < 0) return 3;
    if (days >= 90 && days <= 95) return 5;
    if (days > 95) return 2;
    if (days >= 30 && days < 90) return 1;
    if (days >= 2 && days <= 4) return 4;
    if (days < 30) return 3;
    return 3;
  }

  function updateChartAgeDisplay(days) {
    const display = $("chartAgeDisplay");
    if (!display) return;
    if (days === null || days === undefined) {
      display.textContent = "";
      return;
    }
    if (days < 0) {
      display.textContent = `Service date is ${Math.abs(days)} day(s) in the future.`;
      return;
    }
    display.textContent = `Chart age: ${days} day(s) since visit.`;
  }

  function updateUrgencyHint(suggested) {
    const hint = $("urgencyHint");
    const urgencyField = $("urgency");
    if (!hint || !urgencyField) return;
    const current = Number(urgencyField.value || 3);
    const suggestedDescriptor = getUrgencyDescriptor(suggested);
    const currentDescriptor = getUrgencyDescriptor(current);
    if (!suggestedDescriptor) {
      hint.textContent = currentDescriptor ? `Urgency set to ${currentDescriptor}.` : "";
      return;
    }
    if (current !== suggested) {
      hint.textContent = `Suggested: ${suggestedDescriptor}. (Current: ${currentDescriptor || current})`;
    } else {
      hint.textContent = `Suggested: ${suggestedDescriptor}.`;
    }
  }

  function updateDerivedFields() {
    const dateField = $("dateOfService");
    if (!dateField) return;
    const value = dateField.value;
    const days = calculateDaysSince(value);
    derivedDaysSinceVisit = days;
    updateChartAgeDisplay(days);
    const suggested = getSuggestedUrgency(days);
    const urgencyField = $("urgency");
    if (urgencyField && (urgencyAuto || !urgencyField.value)) {
      urgencyField.value = String(suggested);
    }
    updateUrgencyHint(suggested);
  }

  function setDefaultFieldValues() {
    const nameField = $("name");
    if (nameField) nameField.value = "";
    const categoryField = $("taskCategory");
    if (categoryField) categoryField.value = "General";
    const authorField = $("authorType");
    if (authorField) authorField.value = "attending";
    const patientField = $("patientType");
    if (patientField) patientField.value = "Non-Complex";
    const visitField = $("visitType");
    if (visitField) visitField.value = "Follow-Up";
    const clinicField = $("clinicSite");
    if (clinicField) clinicField.value = "General Clinic";
    NUMERIC_SCALE_FIELDS.forEach(id => {
      const field = $(id);
      if (field) field.value = "1";
    });
    const urgencyField = $("urgency");
    if (urgencyField) urgencyField.value = "3";
    const pressureField = $("externalPressure");
    if (pressureField) pressureField.value = "1";
    const dueDateField = $("dueDate");
    if (dueDateField) dueDateField.value = "";
    const subField = $("initialSubTasks");
    if (subField) subField.value = "";
    const dateField = $("dateOfService");
    if (dateField) {
      dateField.value = formatDateForInput(new Date());
    }
    derivedDaysSinceVisit = calculateDaysSince($("dateOfService")?.value || null);
    urgencyAuto = true;
    updateDerivedFields();
  }

  let tasks = [];
  let templates = [];
  let focusQueue = [];
  let editingTaskId = null;

  function clearFormFields() {
    setDefaultFieldValues();
  }

  function toggleEditMode(isEditing) {
    const addBtn = $("addTaskBtn");
    const saveBtn = $("saveUpdateBtn");
    const cancelBtn = $("cancelEditBtn");
    if (!addBtn || !saveBtn || !cancelBtn) return;
    addBtn.classList.toggle("hidden", isEditing);
    saveBtn.classList.toggle("hidden", !isEditing);
    cancelBtn.classList.toggle("hidden", !isEditing);
  }

  function toNumber(value, fallback = 0) {
    const num = Number(value);
    return Number.isFinite(num) ? num : fallback;
  }

  function clampScale(value, fallback = 1) {
    const base = toNumber(value, fallback);
    return Math.min(5, Math.max(1, base));
  }

  function normalizePatientType(value) {
    const normalized = (value || "").toString().toLowerCase();
    return normalized === "complex" ? "Complex" : "Non-Complex";
  }

  function getPatientTypeWeight(patientType) {
    return normalizePatientType(patientType) === "Complex" ? 1.2 : 1;
  }

  function normalizeVisitType(value) {
    const normalized = (value || "").toString().toLowerCase();
    if (normalized === "establish" || normalized === "establish care") return "Establish Care";
    if (normalized === "well-child" || normalized === "well child visit") return "Well Child Visit";
    if (normalized === "acute" || normalized === "acute visit") return "Acute Visit";
    return "Follow-Up";
  }

  function getVisitTypeWeight(visitType) {
    const normalized = normalizeVisitType(visitType);
    if (normalized === "Establish Care") return 1.3;
    if (normalized === "Well Child Visit") return 1.1;
    if (normalized === "Acute Visit") return 0.9;
    return 1;
  }

  function normalizeClinicSite(value) {
    const normalized = (value || "").toString().toLowerCase().replace(/[‚Äô]/g, "'").trim();
    if (normalized.includes("cranio")) return "Craniofacial Clinic";
    if (normalized.includes("pj")) return "St PJ‚Äôs Shelter";
    if (normalized.includes("general")) return "General Clinic";
    return "General Clinic";
  }

  function isSameLocalDay(dateA, dateB) {
    if (!(dateA instanceof Date) || !(dateB instanceof Date)) return false;
    if (Number.isNaN(dateA.getTime()) || Number.isNaN(dateB.getTime())) return false;
    return dateA.getFullYear() === dateB.getFullYear()
      && dateA.getMonth() === dateB.getMonth()
      && dateA.getDate() === dateB.getDate();
  }

  function getSameDayBonus(clinicSite, createdAt) {
    const normalizedClinic = normalizeClinicSite(clinicSite);
    if (normalizedClinic !== "St PJ‚Äôs Shelter" && normalizedClinic !== "Craniofacial Clinic") {
      return 1;
    }
    if (!createdAt) return 1;
    const createdDate = new Date(createdAt);
    if (Number.isNaN(createdDate.getTime())) return 1;
    const now = new Date();
    return isSameLocalDay(createdDate, now) ? 2 : 1;
  }

  function computePriority(t) {
    if (Array.isArray(t.subTasks) && t.subTasks.length) {
      const remaining = t.subTasks.filter(s => !s.completed);
      if (remaining.length === 0) return 0;
      const total = remaining.reduce((sum,s) => sum + s.priority, 0);
      return total / remaining.length;
    }
    const importance = clampScale(t.importance, 1);
    const urgency = clampScale(t.urgency, 3);
    const novelty = clampScale(t.novelty, 1);
    const interest = clampScale(t.interest, 1);
    const pressure = clampScale(t.externalPressure, 1);
    const timeToStart = clampScale(t.timeToStart, 1);
    const difficulty = clampScale(t.difficulty, 1);
    const dopamine = novelty + interest;
    const friction = (6 - timeToStart) + (6 - difficulty);
    const baseScore = (importance * 2)
         + (urgency * 2)
         + (dopamine * 2)
         + (pressure * 5)
         + (friction * 1.5);
    const patientWeight = getPatientTypeWeight(t.patientType);
    const visitWeight = getVisitTypeWeight(t.visitType);
    const sameDayBonus = getSameDayBonus(t.clinicSite, t.createdAt);
    return baseScore * patientWeight * visitWeight * sameDayBonus;
  }

  function recalcTaskPriority(task) {
    if (!task) return task;
    const normalized = { ...task };
    normalized.authorType = normalized.authorType || "attending";
    normalized.patientType = normalizePatientType(normalized.patientType);
    normalized.visitType = normalizeVisitType(normalized.visitType);
    normalized.clinicSite = normalizeClinicSite(normalized.clinicSite);
    normalized.dateOfService = normalized.dateOfService || null;
    normalized.createdAt = normalized.createdAt || normalized.addedAt || new Date().toISOString();
    if (normalized.category === "Charts") normalized.category = "Chart";
    if (normalized.dateOfService) {
      normalized.daysSinceVisit = calculateDaysSince(normalized.dateOfService);
    } else {
      const parsedDays = Number(normalized.daysSinceVisit);
      normalized.daysSinceVisit = (normalized.daysSinceVisit === null || normalized.daysSinceVisit === undefined || normalized.daysSinceVisit === "" || !Number.isFinite(parsedDays))
        ? null
        : parsedDays;
    }
    normalized.urgency = clampScale(normalized.urgency, 3);
    normalized.importance = clampScale(normalized.importance, 1);
    normalized.novelty = clampScale(normalized.novelty, 1);
    normalized.interest = clampScale(normalized.interest, 1);
    normalized.externalPressure = clampScale(normalized.externalPressure, 1);
    normalized.timeToStart = clampScale(normalized.timeToStart, 1);
    normalized.difficulty = clampScale(normalized.difficulty, 1);
    if (Array.isArray(normalized.subTasks) && normalized.subTasks.length) {
      const base = computePriority({ ...normalized, subTasks: [] });
      normalized.subTasks = normalized.subTasks.map(sub => ({
        ...sub,
        priority: base
      }));
    }
    normalized.priority = computePriority(normalized);
    return normalized;
  }

  function persist() {
    localStorage.setItem("tasks", JSON.stringify(tasks));
  }

  // create a new task with optional sub‚Äëtasks from textarea
  function addTask() {
    const name = $("name").value.trim();
    if (!name) return;
    const authorField = $("authorType");
    const authorType = authorField ? (authorField.value || "attending") : "attending";
    const patientField = $("patientType");
    const patientType = normalizePatientType(patientField ? patientField.value : "Non-Complex");
    const visitField = $("visitType");
    const visitType = normalizeVisitType(visitField ? visitField.value : "Follow-Up");
    const clinicField = $("clinicSite");
    const clinicSite = normalizeClinicSite(clinicField ? clinicField.value : "General Clinic");
    const dateField = $("dateOfService");
    const dateOfService = dateField && dateField.value ? dateField.value : null;
    const daysSinceVisit = calculateDaysSince(dateOfService);
    const task = {
      id: Date.now().toString(),
      name,
      category: $("taskCategory").value || "General",
      authorType,
      patientType,
      visitType,
      clinicSite,
      dateOfService,
      daysSinceVisit,
      importance: clampScale($("importance").value, 1),
      urgency: clampScale($("urgency").value, 3),
      novelty: clampScale($("novelty").value, 1),
      interest: clampScale($("interest").value, 1),
      externalPressure: clampScale($("externalPressure").value, 1),
      timeToStart: clampScale($("timeToStart").value, 1),
      difficulty: clampScale($("difficulty").value, 1),
      dueDate: $("dueDate").value || null,
      completed: false,
      createdAt: new Date().toISOString(),
      addedAt: new Date().toISOString(),
      subTasks: []
    };

    // base priority for sub‚Äëtasks
    const basePriority = computePriority(task);

    // parse sub‚Äëtasks from textarea (one per line)
    const subLines = $("initialSubTasks").value.split('\n')
      .map(l => l.trim())
      .filter(Boolean);
    task.subTasks = subLines.map(line => ({
      id: Date.now().toString() + Math.random().toString(36).slice(2,8),
      name: line,
      completed: false,
      priority: basePriority
    }));


    task.priority = computePriority(task);
    tasks.push(task);
    persist();

    clearFormFields();
    toggleEditMode(false);
    editingTaskId = null;
    updateUI();
  }

  function startEditTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    editingTaskId = taskId;
    $("name").value = task.name;
    $("taskCategory").value = task.category || "General";
    $("importance").value = String(task.importance || 1);
    $("urgency").value = String(task.urgency || 3);
    $("novelty").value = String(task.novelty || 1);
    $("interest").value = String(task.interest || 1);
    const authorField = $("authorType");
    if (authorField) authorField.value = task.authorType || "attending";
    const patientField = $("patientType");
    if (patientField) patientField.value = normalizePatientType(task.patientType);
    const visitField = $("visitType");
    if (visitField) visitField.value = normalizeVisitType(task.visitType);
    const clinicField = $("clinicSite");
    if (clinicField) clinicField.value = normalizeClinicSite(task.clinicSite);
    const dateField = $("dateOfService");
    if (dateField) {
      if (task.dateOfService) {
        dateField.value = task.dateOfService;
      } else {
        dateField.value = formatDateForInput(new Date());
      }
    }
    urgencyAuto = false;
    derivedDaysSinceVisit = task.daysSinceVisit ?? calculateDaysSince($("dateOfService")?.value || null);
    updateDerivedFields();
    const pressureField = $("externalPressure");
    if (pressureField) {
      const pressureValue = task.externalPressure;
      pressureField.value = String(pressureValue || 1);
    }
    $("timeToStart").value = String(task.timeToStart || 1);
    $("difficulty").value = String(task.difficulty || 1);
    $("dueDate").value = task.dueDate || "";
    const subs = Array.isArray(task.subTasks) ? task.subTasks.map(sub => sub.name).join("\n") : "";
    $("initialSubTasks").value = subs;
    toggleEditMode(true);
    $("name").focus();
  }

  function saveTaskUpdate() {
    if (!editingTaskId) return;
    const idx = tasks.findIndex(t => t.id === editingTaskId);
    if (idx === -1) return;
    const name = $("name").value.trim();
    if (!name) return;

    const task = tasks[idx];
    task.name = name;
    task.category = $("taskCategory").value || "General";
    const authorField = $("authorType");
    task.authorType = authorField ? (authorField.value || "attending") : "attending";
    const patientField = $("patientType");
    task.patientType = normalizePatientType(patientField ? patientField.value : task.patientType);
    const visitField = $("visitType");
    task.visitType = normalizeVisitType(visitField ? visitField.value : task.visitType);
    const clinicField = $("clinicSite");
    task.clinicSite = normalizeClinicSite(clinicField ? clinicField.value : task.clinicSite);
    const dateField = $("dateOfService");
    task.dateOfService = dateField && dateField.value ? dateField.value : null;
    task.daysSinceVisit = calculateDaysSince(task.dateOfService);
    task.importance = clampScale($("importance").value, 1);
    task.urgency = clampScale($("urgency").value, 3);
    task.novelty = clampScale($("novelty").value, 1);
    task.interest = clampScale($("interest").value, 1);
    task.externalPressure = clampScale($("externalPressure").value, 1);
    task.timeToStart = clampScale($("timeToStart").value, 1);
    task.difficulty = clampScale($("difficulty").value, 1);
    task.dueDate = $("dueDate").value || null;
    task.updatedAt = new Date().toISOString();

    const subLines = $("initialSubTasks").value.split('\n')
      .map(line => line.trim())
      .filter(Boolean);

    const basePriority = computePriority({ ...task, subTasks: [] });
    const existingSubs = Array.isArray(task.subTasks) ? task.subTasks.slice() : [];
    const newSubTasks = subLines.map(line => {
      const matchIndex = existingSubs.findIndex(sub => sub.name === line);
      if (matchIndex !== -1) {
        const existing = existingSubs.splice(matchIndex, 1)[0];
        return { ...existing, name: line };
      }
      return {
        id: Date.now().toString() + Math.random().toString(36).slice(2, 8),
        name: line,
        completed: false,
        priority: basePriority
      };
    });

    task.subTasks = newSubTasks;
    task.subTasks.forEach(sub => {
      sub.priority = basePriority;
    });
    task.priority = computePriority(task);
    persist();

    toggleEditMode(false);
    clearFormFields();
    editingTaskId = null;
    updateUI();
  }

  function cancelEdit() {
    editingTaskId = null;
    toggleEditMode(false);
    clearFormFields();
  }

  // render filter bar
  function renderCategoryFilter() {
    const bar = $("categoryFilter");
    bar.innerHTML = "";
    ["All", ...categories].forEach(cat => {
      const btn = document.createElement("button");
      btn.textContent = cat;
      btn.className = (cat === activeCategory) ? "active" : "";
      btn.onclick = () => { activeCategory = cat; updateUI(); };
      bar.appendChild(btn);
    });
  }

  // render progress per category
  function renderCategoryProgress() {
    const cont = $("categoryProgress");
    cont.innerHTML = "";
    categories.forEach(cat => {
      const total = tasks.filter(t => t.category === cat).length;
      if (total === 0) return;
      const done = tasks.filter(t => t.category === cat && t.completed).length;
      const percent = (done / total) * 100;

      const line = document.createElement("div");
      line.className = "line";
      const title = document.createElement("span");
      title.textContent = `${cat}: ${done}/${total} complete`;
      line.appendChild(title);

      const bar = document.createElement("div");
      bar.className = "bar";
      const fill = document.createElement("span");
      fill.className = "fill";
      fill.style.width = percent + "%";
      bar.appendChild(fill);

      line.appendChild(bar);
      cont.appendChild(line);
    });
  }

  // main UI update
  function updateUI() {
    tasks = tasks.map(recalcTaskPriority);
    persist();
    renderCategoryFilter();
    renderCategoryProgress();

    const taskList = $("taskList");
    taskList.innerHTML = "";

    const remaining = tasks.filter(t => !t.completed && (activeCategory === "All" || t.category === activeCategory));
    $("startBtn").disabled = remaining.length === 0;

    // sort tasks by priority for display (use copy)
    const displayTasks = tasks.slice().sort((a,b) => b.priority - a.priority);
    displayTasks.forEach(t => {
      if (activeCategory !== "All" && t.category !== activeCategory) return;
      const idx = tasks.findIndex(item => item.id === t.id);
      const div = document.createElement("div");
      div.className = "task";
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.gap = "0.5rem";
      const info = document.createElement("span");
      info.textContent = `${t.name} ${t.completed ? "(‚úì)" : ""} ‚Äî ${t.priority.toFixed(1)}`;
      const actions = document.createElement("span");
      actions.style.display = "flex";
      actions.style.gap = "0.25rem";
      const editBtn = document.createElement("button");
      editBtn.textContent = "‚úèÔ∏è";
      editBtn.title = "Edit task";
      editBtn.onclick = () => {
        startEditTask(t.id);
      };
      const delBtn = document.createElement("button");
      delBtn.textContent = "üóëÔ∏è";
      delBtn.title = "Delete task";
      delBtn.onclick = () => {
        if (!confirm("Delete this task?")) return;
        if (editingTaskId === t.id) {
          cancelEdit();
        }
        tasks.splice(idx, 1);
        persist();
        updateUI();
      };
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      row.appendChild(info);
      row.appendChild(actions);
      div.appendChild(row);

      if (t.addedAt) {
        const ts = document.createElement("div");
        ts.className = "score";
        ts.textContent = `Added: ${new Date(t.addedAt).toLocaleString()}`;
        div.appendChild(ts);
      }
      if (t.dueDate) {
        const dd = document.createElement("div");
        dd.className = "score";
        dd.textContent = `Due: ${t.dueDate}`;
        div.appendChild(dd);
      }

      const age = t.dateOfService ? calculateDaysSince(t.dateOfService) : (
        t.daysSinceVisit === null || t.daysSinceVisit === undefined || t.daysSinceVisit === ""
          ? null
          : Number(t.daysSinceVisit)
      );
      if (age !== null && Number.isFinite(age)) {
        const daysInfo = document.createElement("div");
        daysInfo.className = "score";
        const ageLabel = age < 0
          ? `${Math.abs(age)} day(s) until visit`
          : `${age} day(s) since visit`;
        const visitLabel = t.dateOfService ? `Visit: ${t.dateOfService}` : "Chart age";
        daysInfo.textContent = `${visitLabel} ‚Äî ${ageLabel}`;
        div.appendChild(daysInfo);
      }

      if (t.authorType) {
        const authorInfo = document.createElement("div");
        authorInfo.className = "score";
        const label = String(t.authorType).toLowerCase() === "resident" ? "Resident" : "Attending";
        authorInfo.textContent = `Author: ${label}`;
        div.appendChild(authorInfo);
      }

      if (t.subTasks && t.subTasks.length) {
        const completedCount = t.subTasks.filter(s => s.completed).length;
        const progress = document.createElement("div");
        progress.className = "score";
        progress.textContent = `${completedCount}/${t.subTasks.length} steps done`;
        div.appendChild(progress);

        t.subTasks.forEach((sub, subIndex) => {
          const subRow = document.createElement("div");
          subRow.style.display = "flex";
          subRow.style.alignItems = "center";
          subRow.style.marginLeft = "1rem";
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.checked = sub.completed;
          chk.onchange = () => completeSubTask(idx, subIndex);
          const label = document.createElement("span");
          label.textContent = sub.name;
          label.style.marginLeft = "0.25rem";
          subRow.appendChild(chk);
          subRow.appendChild(label);
          div.appendChild(subRow);
        });
      }

      taskList.appendChild(div);
    });

    // tasks due today
    const dueTodayList = $("dueTodayList");
    dueTodayList.innerHTML = "";
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const today = now.toISOString().split("T")[0];

    tasks.forEach((task, idx) => {
      if (task.completed) return;
      if (activeCategory !== "All" && task.category !== activeCategory) return;
      if (task.dueDate === today) {
        const wrap = document.createElement("div");
        wrap.textContent = `${task.name} ‚Äî due today`;

        if (task.subTasks && task.subTasks.length) {
          const completedCount = task.subTasks.filter(s => s.completed).length;
          const progress = document.createElement("div");
          progress.className = "score";
          progress.textContent = `${completedCount}/${task.subTasks.length} steps done`;
          wrap.appendChild(progress);

          task.subTasks.forEach((sub, subIndex) => {
            const subRow = document.createElement("div");
            subRow.style.display = "flex";
            subRow.style.alignItems = "center";
            subRow.style.marginLeft = "1rem";
            const chk = document.createElement("input");
            chk.type = "checkbox";
            chk.checked = sub.completed;
            chk.onchange = () => completeSubTask(idx, subIndex);
            const label = document.createElement("span");
            label.textContent = sub.name;
            label.style.marginLeft = "0.25rem";
            subRow.appendChild(chk);
            subRow.appendChild(label);
            wrap.appendChild(subRow);
          });
        }

        dueTodayList.appendChild(wrap);
      }
    });
  }

  function startFocus() {
    if (editingTaskId) cancelEdit();
    $("capture").classList.add("hidden");
    $("focus").classList.remove("hidden");
    focusQueue = tasks.filter(t => !t.completed && (activeCategory === "All" || t.category === activeCategory))
      .sort((a,b) => b.priority - a.priority);
    showNextTask();
  }

  function showNextTask() {
    const display = document.querySelector(".focus");
    const scoreView = $("scoreView");
    const subTaskView = $("subTaskView");
    if (focusQueue.length === 0) {
      display.textContent = "‚úÖ All tasks complete!";
      scoreView.textContent = "";
      subTaskView.innerHTML = "";
      return;
    }
    const current = focusQueue[0];
    display.textContent = current.name;
    scoreView.textContent = `Score: ${current.priority.toFixed(1)}`;

    const idx = tasks.findIndex(t => t.id === current.id);

    subTaskView.innerHTML = "";
    if (current.subTasks && current.subTasks.length) {
      current.subTasks.forEach((sub, subIndex) => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.checked = sub.completed;
        chk.onchange = () => completeSubTask(idx, subIndex);
        const label = document.createElement("span");
        label.textContent = sub.name;
        label.style.marginLeft = "0.25rem";
        row.appendChild(chk);
        row.appendChild(label);
        subTaskView.appendChild(row);
      });
    } else {
      subTaskView.textContent = "No sub‚Äëtasks for this task.";
    }
  }

  function completeTask() {
    if (!focusQueue.length) return;
    focusQueue[0].completed = true;
    persist();
    updateUI();
    focusQueue.shift();
    showNextTask();
  }

  function backToCapture() {
    $("focus").classList.add("hidden");
    $("capture").classList.remove("hidden");
    updateUI();
  }

  function reset() {
    if (!confirm("Clear all tasks?")) return;
    cancelEdit();
    tasks = [];
    localStorage.removeItem("tasks");
    updateUI();
  }

  function saveAsTemplate() {
    const name = $("name").value.trim();
    if (!name) return alert("Task name is required");
    const authorField = $("authorType");
    const authorType = authorField ? (authorField.value || "attending") : "attending";
    const patientField = $("patientType");
    const patientType = normalizePatientType(patientField ? patientField.value : "Non-Complex");
    const visitField = $("visitType");
    const visitType = normalizeVisitType(visitField ? visitField.value : "Follow-Up");
    const clinicField = $("clinicSite");
    const clinicSite = normalizeClinicSite(clinicField ? clinicField.value : "General Clinic");
    const template = {
      name,
      category: $("taskCategory").value || "General",
      authorType,
      patientType,
      visitType,
      clinicSite,
      importance: clampScale($("importance").value, 1),
      urgency: clampScale($("urgency").value, 3),
      novelty: clampScale($("novelty").value, 1),
      interest: clampScale($("interest").value, 1),
      externalPressure: clampScale($("externalPressure").value, 1),
      timeToStart: clampScale($("timeToStart").value, 1),
      difficulty: clampScale($("difficulty").value, 1)
    };
    templates.push(template);
    localStorage.setItem("templates", JSON.stringify(templates));
    renderTemplates();
  }

  function renderTemplates() {
    const container = $("templateButtons");
    container.innerHTML = "";
    templates.forEach((t, i) => {
      const wrapper = document.createElement("div");
      const useBtn = document.createElement("button");
      useBtn.textContent = `üìã ${t.name}`;
      useBtn.onclick = () => {
        $("name").value = t.name;
        $("taskCategory").value = t.category || "General";
        $("importance").value = String(t.importance || 1);
        $("novelty").value = String(t.novelty || 1);
        $("interest").value = String(t.interest || 1);
        const authorField = $("authorType");
        if (authorField) authorField.value = t.authorType || "attending";
        const patientField = $("patientType");
        if (patientField) patientField.value = normalizePatientType(t.patientType);
        const visitField = $("visitType");
        if (visitField) visitField.value = normalizeVisitType(t.visitType);
        const clinicField = $("clinicSite");
        if (clinicField) clinicField.value = normalizeClinicSite(t.clinicSite);
        const urgencyField = $("urgency");
        if (urgencyField) urgencyField.value = String(t.urgency || 3);
        const pressureField = $("externalPressure");
        if (pressureField) {
          pressureField.value = String(t.externalPressure || 1);
        }
        $("timeToStart").value = String(t.timeToStart || 1);
        $("difficulty").value = String(t.difficulty || 1);
        const dateField = $("dateOfService");
        if (dateField) dateField.value = formatDateForInput(new Date());
        urgencyAuto = false;
        updateDerivedFields();
      };
      const editBtn = document.createElement("button");
      editBtn.textContent = "‚úèÔ∏è Edit";
      editBtn.onclick = () => {
        const newName = prompt("Edit template name:", t.name);
        if (!newName) return;
        t.name = newName;
        localStorage.setItem("templates", JSON.stringify(templates));
        renderTemplates();
      };
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "üóëÔ∏è Delete";
      deleteBtn.onclick = () => {
        if (!confirm("Delete this template?")) return;
        templates.splice(i, 1);
        localStorage.setItem("templates", JSON.stringify(templates));
        renderTemplates();
      };
      [useBtn, editBtn, deleteBtn].forEach(b => {
        b.style.marginRight = "0.3rem";
        b.style.fontSize = "0.9rem";
      });
      wrapper.appendChild(useBtn);
      wrapper.appendChild(editBtn);
      wrapper.appendChild(deleteBtn);
      container.appendChild(wrapper);
    });
  }

  function completeSubTask(taskIndex, subIndex) {
    const parent = tasks[taskIndex];
    if (!parent || !parent.subTasks) return;
    const sub = parent.subTasks[subIndex];
    if (!sub) return;
    sub.completed = true;
    parent.priority = computePriority(parent);
    persist();
    updateUI();
  }

  function updateBillingReminder() {
    const reminder = $("billingReminder");
    if (!reminder) return;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const cutoff = new Date(today);
    cutoff.setDate(cutoff.getDate() - 95);
    const formatted = cutoff.toLocaleDateString(undefined, {
      year: "numeric",
      month: "short",
      day: "numeric"
    });
    reminder.textContent = `Make sure that "all charts from ${formatted} must be completed today to be eligible for billing".`;
  }

  function registerFieldListeners() {
    const dateField = $("dateOfService");
    if (dateField) {
      dateField.addEventListener("change", () => {
        updateDerivedFields();
      });
    }
    const urgencyField = $("urgency");
    if (urgencyField) {
      urgencyField.addEventListener("change", () => {
        urgencyAuto = false;
        updateUrgencyHint(getSuggestedUrgency(derivedDaysSinceVisit));
      });
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    registerFieldListeners();
    setDefaultFieldValues();
    updateBillingReminder();
    const saved = localStorage.getItem("tasks");
    if (saved) {
      tasks = JSON.parse(saved).map(task => {
        const normalizedTask = {
          ...task,
          authorType: task.authorType || "attending",
          patientType: normalizePatientType(task.patientType),
          visitType: normalizeVisitType(task.visitType),
          clinicSite: normalizeClinicSite(task.clinicSite),
          dateOfService: task.dateOfService || null,
          createdAt: task.createdAt || task.addedAt || new Date().toISOString()
        };
        if (normalizedTask.dateOfService) {
          normalizedTask.daysSinceVisit = calculateDaysSince(normalizedTask.dateOfService);
        }
        return recalcTaskPriority(normalizedTask);
      });
    }
    const savedTemplates = localStorage.getItem("templates");
    if (savedTemplates) {
      templates = JSON.parse(savedTemplates).map(template => ({
        ...template,
        authorType: template.authorType || "attending",
        patientType: normalizePatientType(template.patientType),
        visitType: normalizeVisitType(template.visitType),
        clinicSite: normalizeClinicSite(template.clinicSite)
      }));
    }
    renderTemplates();
    updateUI();
    updateDerivedFields();
  });
  </script>
</body>
</html>
