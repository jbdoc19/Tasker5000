<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tasker5000 Focus Flow</title>
    <style>
      :root {
        color-scheme: dark;
        --ink: #f2fbff;
        --ink-muted: #9fb1c0;
        --backdrop: #06090f;
        --surface: rgba(13, 19, 27, 0.92);
        --surface-high: rgba(18, 27, 36, 0.96);
        --surface-low: rgba(8, 12, 18, 0.85);
        --teal: #2dd4c3;
        --teal-strong: #1fb7a7;
        --teal-soft: rgba(45, 212, 195, 0.18);
        --rescue: #f9707a;
        --card-radius: 18px;
        --nav-height: 76px;
        --capture-height: 58px;
        font-family: "Inter", "SF Pro Display", "Segoe UI", system-ui, sans-serif;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, rgba(45, 212, 195, 0.08), rgba(6, 9, 15, 0.95)),
          var(--backdrop);
        color: var(--ink);
        display: flex;
        justify-content: center;
      }

      .app-shell {
        width: min(420px, 100vw);
        min-height: 100vh;
        display: grid;
        grid-template-rows: auto 1fr auto;
        padding: 16px 16px calc(var(--nav-height) + 16px);
        position: relative;
        background: linear-gradient(180deg, rgba(5, 10, 16, 0.94), rgba(5, 10, 16, 0.88));
        overflow: hidden;
      }

      header.app-headline {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 12px;
      }

      header.app-headline h1 {
        margin: 0;
        font-size: 1.25rem;
        letter-spacing: 0.01em;
      }

      header.app-headline span {
        color: var(--ink-muted);
        font-size: 0.85rem;
      }

      main.focus-stage {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding-bottom: 12px;
      }

      .sprint-bar {
        position: relative;
        border-radius: var(--card-radius);
        padding: 18px;
        border: 1px solid rgba(45, 212, 195, 0.32);
        background: linear-gradient(135deg, rgba(45, 212, 195, 0.25), rgba(45, 212, 195, 0.08));
        color: #022826;
        cursor: pointer;
        overflow: hidden;
        transition: transform 180ms ease, box-shadow 200ms ease, background 200ms ease;
        touch-action: manipulation;
      }

      .sprint-bar:active {
        transform: scale(0.99);
      }

      .sprint-bar::after {
        content: "";
        position: absolute;
        inset: 6px;
        border-radius: var(--card-radius);
        border: 1px solid rgba(255, 255, 255, 0.25);
        opacity: 0;
        transform: scale(0.92);
        transition: opacity 220ms ease, transform 220ms ease;
      }

      .sprint-bar.glow::after {
        opacity: 1;
        transform: scale(1);
      }

      .sprint-bar .label {
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: 0.015em;
      }

      .sprint-bar .metrics {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        color: rgba(255, 255, 255, 0.82);
        font-size: 0.82rem;
      }

      .sprint-bar.active {
        background: linear-gradient(135deg, rgba(45, 212, 195, 0.4), rgba(13, 180, 163, 0.2));
        box-shadow: 0 18px 30px rgba(45, 212, 195, 0.25);
      }

      .sprint-bar.complete {
        background: linear-gradient(135deg, rgba(45, 212, 195, 0.6), rgba(154, 246, 227, 0.45));
      }

      .sprint-pulse {
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(circle at center, rgba(45, 212, 195, 0.45), transparent 65%);
        opacity: 0;
        transition: opacity 220ms ease;
        animation: gentle-pulse 2.4s ease-in-out infinite;
      }

      .sprint-bar.active .sprint-pulse {
        opacity: 0.45;
      }

      @keyframes gentle-pulse {
        0%,
        100% {
          transform: scale(0.98);
        }
        50% {
          transform: scale(1.04);
        }
      }

      .support {
        position: relative;
      }

      .support-dock {
        display: flex;
        justify-content: flex-end;
      }

      .rescue-pill {
        border-radius: 999px;
        background: rgba(249, 112, 122, 0.24);
        border: 1px solid rgba(249, 112, 122, 0.45);
        color: #ffd5d7;
        font-weight: 600;
        padding: 10px 24px;
        transition: transform 160ms ease, box-shadow 180ms ease;
      }

      .rescue-pill:active {
        transform: scale(0.97);
      }

      .support-ribbon {
        position: absolute;
        inset: auto 0 0 0;
        transform: translateY(calc(100% + 16px));
        border-radius: calc(var(--card-radius) - 2px);
        border: 1px solid rgba(79, 99, 119, 0.35);
        background: var(--surface);
        padding: 18px 16px;
        display: grid;
        gap: 16px;
        box-shadow: 0 18px 32px rgba(3, 8, 14, 0.6);
        transition: transform 220ms ease, opacity 200ms ease;
        opacity: 0;
        pointer-events: none;
        z-index: 55;
      }

      .support-ribbon.visible {
        transform: translateY(0);
        opacity: 1;
        pointer-events: auto;
      }

      .support-ribbon .ribbon-handle {
        width: 46px;
        height: 4px;
        border-radius: 4px;
        background: rgba(148, 163, 184, 0.4);
        margin: 0 auto;
      }

      .support-ribbon .calm-tools {
        display: flex;
        gap: 12px;
        justify-content: space-between;
      }

      .support-ribbon .toggle {
        flex: 1;
        padding: 10px 0;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(148, 163, 184, 0.15);
        font-size: 1.1rem;
        text-align: center;
      }

      .support-ribbon .toggle[aria-pressed="true"] {
        background: rgba(255, 255, 255, 0.12);
      }

      .rescue-sheet {
        position: fixed;
        inset: auto 0 0;
        transform: translateY(100%);
        background: rgba(10, 15, 21, 0.96);
        border-radius: var(--card-radius) var(--card-radius) 0 0;
        border: 1px solid rgba(249, 112, 122, 0.35);
        box-shadow: 0 -24px 36px rgba(6, 9, 15, 0.6);
        padding: 22px 20px 36px;
        display: grid;
        gap: 18px;
        transition: transform 220ms ease;
        z-index: 80;
        pointer-events: none;
      }

      .rescue-sheet.open {
        transform: translateY(0);
        pointer-events: auto;
      }

      .rescue-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .rescue-head h3 {
        margin: 0;
        font-size: 1rem;
        letter-spacing: 0.015em;
      }

      .rescue-head button {
        background: none;
        border: 1px solid rgba(249, 112, 122, 0.35);
        border-radius: 12px;
        color: rgba(255, 226, 228, 0.85);
        padding: 6px 12px;
        font-size: 0.9rem;
      }

      .rescue-tabs {
        display: flex;
        gap: 8px;
      }

      .rescue-tab {
        flex: 1;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(249, 112, 122, 0.35);
        background: rgba(249, 112, 122, 0.12);
        color: #ffedef;
        font-weight: 600;
      }

      .rescue-tab.active {
        background: rgba(249, 112, 122, 0.24);
      }

      .rescue-body {
        font-size: 0.9rem;
        line-height: 1.5;
        color: rgba(255, 228, 230, 0.88);
      }

      .focus-corridor {
        display: grid;
        gap: 14px;
        padding: 6px 4px 4px;
      }

      .focus-card-shell {
        position: relative;
        overflow: hidden;
        border-radius: calc(var(--card-radius) + 4px);
        border: 1px solid rgba(148, 163, 184, 0.24);
        background: var(--surface-high);
        padding: 22px 18px;
        box-shadow: 0 22px 40px rgba(4, 10, 18, 0.55);
      }

      .focus-card {
        display: grid;
        gap: 8px;
        transition: transform 220ms ease, opacity 200ms ease;
      }

      .focus-card.swipe-left {
        transform: translateX(-30%);
        opacity: 0.6;
      }

      .focus-card.swipe-right {
        transform: translateX(30%);
        opacity: 0.6;
      }

      .focus-card .slot {
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 0.7rem;
        color: var(--teal);
      }

      .focus-card h2 {
        margin: 0;
        font-size: 1.35rem;
      }

      .focus-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        color: var(--ink-muted);
        font-size: 0.78rem;
      }

      .focus-alt-chips {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 6px;
      }

      .focus-alt-chips::-webkit-scrollbar {
        display: none;
      }

      .focus-chip {
        flex: 0 0 auto;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.14);
        border: 1px solid rgba(148, 163, 184, 0.22);
        font-size: 0.78rem;
        color: var(--ink-muted);
      }

      .focus-tools-row {
        display: flex;
        gap: 10px;
      }

      .focus-inline-panel {
        border-radius: var(--card-radius);
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(7, 13, 20, 0.88);
        padding: 14px 16px;
        font-size: 0.85rem;
        color: var(--ink-muted);
        display: none;
      }

      .focus-inline-panel.active {
        display: block;
      }

      .focus-tools-row button {
        flex: 1;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(255, 255, 255, 0.04);
        color: var(--ink);
        font-size: 0.85rem;
      }

      .accordion {
        background: var(--surface);
        border-radius: var(--card-radius);
        border: 1px solid rgba(148, 163, 184, 0.18);
        overflow: hidden;
      }

      .accordion + .accordion {
        margin-top: 14px;
      }

      .accordion-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        position: sticky;
        top: 0;
        background: inherit;
        z-index: 10;
      }

      .accordion-header span {
        color: var(--ink-muted);
        font-weight: 500;
        font-size: 0.85rem;
      }

      .accordion-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 200ms ease;
      }

      .accordion.open .accordion-body {
        max-height: 320px;
      }

      .task-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 16px;
        border-top: 1px solid rgba(148, 163, 184, 0.1);
      }

      .task-row strong {
        font-size: 0.92rem;
        flex: 1;
      }

      .task-row button {
        border-radius: 12px;
        padding: 6px 12px;
        font-size: 0.78rem;
        background: rgba(45, 212, 195, 0.16);
        border: 1px solid rgba(45, 212, 195, 0.28);
        color: var(--teal);
      }

      .task-row:last-child {
        padding-bottom: 20px;
      }

      .task-row.add-new button {
        width: 100%;
        justify-content: center;
        font-weight: 600;
        background: rgba(45, 212, 195, 0.2);
        color: #0a2d2a;
      }

      .bottom-area {
        position: fixed;
        inset: auto 0 0;
        background: rgba(5, 10, 16, 0.96);
        display: grid;
        gap: 8px;
        padding: 10px 16px calc(env(safe-area-inset-bottom) + 10px);
        pointer-events: none;
        z-index: 50;
      }

      .bottom-area > * {
        pointer-events: auto;
      }

      .bottom-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 999px;
        padding: 12px 18px;
        background: rgba(18, 27, 36, 0.92);
        border: 1px solid rgba(148, 163, 184, 0.22);
        backdrop-filter: blur(14px);
        height: var(--nav-height);
      }

      .nav-item {
        display: grid;
        place-items: center;
        gap: 4px;
        color: var(--ink-muted);
        font-size: 0.68rem;
      }

      .nav-item.active {
        color: var(--teal);
      }

      .nav-item span.icon {
        font-size: 1.3rem;
      }

      .capture-trigger {
        width: 50px;
        height: 50px;
        border-radius: 18px;
        background: var(--teal);
        border: none;
        color: #032623;
        font-size: 2rem;
        display: grid;
        place-items: center;
        font-weight: 500;
        box-shadow: 0 12px 28px rgba(45, 212, 195, 0.35);
        transition: transform 160ms ease;
        position: relative;
      }

      .capture-trigger:active {
        transform: scale(0.94);
      }

      .capture-strip {
        position: relative;
        border-radius: 20px;
        border: 1px solid rgba(45, 212, 195, 0.35);
        background: rgba(8, 20, 20, 0.96);
        overflow: hidden;
        transform: translateY(calc(100% + 12px));
        transition: transform 200ms ease, opacity 200ms ease;
        height: var(--capture-height);
        display: flex;
        align-items: center;
        padding: 0 12px;
        gap: 10px;
        pointer-events: none;
        opacity: 0;
      }

      .capture-strip.open {
        transform: translateY(0);
        pointer-events: auto;
        opacity: 1;
      }

      .capture-strip input {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--ink);
        font-size: 0.95rem;
        outline: none;
      }

      .capture-strip button {
        border-radius: 14px;
        background: var(--teal);
        border: none;
        color: #032623;
        font-weight: 600;
        padding: 8px 14px;
      }

      .smart-nudge {
        position: relative;
        border-radius: 16px;
        background: rgba(25, 35, 45, 0.92);
        border: 1px solid rgba(148, 163, 184, 0.22);
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 0.85rem;
        color: var(--ink-muted);
        opacity: 0;
        pointer-events: none;
        transform: translateY(20px);
        transition: opacity 200ms ease, transform 200ms ease;
      }

      .smart-nudge.visible {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }

      .corridor-scrim {
        position: fixed;
        inset: 0;
        background: rgba(4, 9, 15, 0.6);
        opacity: 0;
        pointer-events: none;
        transition: opacity 200ms ease;
        z-index: 70;
      }

      .corridor-scrim.visible {
        opacity: 1;
        pointer-events: auto;
      }

      #zDebugOutline {
        position: fixed;
        border: 1px dashed rgba(255, 0, 128, 0.8);
        pointer-events: none;
        mix-blend-mode: screen;
        z-index: 999;
        transition: all 120ms ease;
      }

      .app-shell.capture-open {
        padding-bottom: calc(var(--nav-height) + var(--capture-height) + 28px);
      }

      .smart-nudge button {
        border-radius: 12px;
        padding: 6px 10px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(255, 255, 255, 0.05);
        color: var(--ink);
        font-size: 0.78rem;
      }

      .confetti {
        pointer-events: none;
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.2), transparent 40%),
          repeating-linear-gradient(105deg, rgba(255, 255, 255, 0.15) 0 4px, transparent 4px 8px);
        opacity: 0;
        animation: confetti 600ms ease forwards;
      }

      @keyframes confetti {
        0% {
          opacity: 0;
          transform: translateY(10px) scale(0.9);
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translateY(-10px) scale(1.05);
        }
      }

      @media (max-width: 380px) {
        .app-shell {
          padding-left: 12px;
          padding-right: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell" id="appShell">
      <header class="app-headline">
        <h1>Focus Corridor</h1>
        <span>One glide at a time</span>
      </header>
      <main class="focus-stage">
        <section class="sprint" aria-label="Focus sprint">
          <button class="sprint-bar start-action" id="sprintBar" type="button">
            <div class="sprint-pulse" aria-hidden="true"></div>
            <div class="label" id="sprintLabel">Start 5-min</div>
            <div class="metrics" id="sprintMetrics">
              <span data-metric="elapsed">Elapsed 00:00</span>
              <span data-metric="streak">Streak · 2 days</span>
              <span data-metric="encouragement">Ready when you are</span>
            </div>
          </button>
        </section>
        <section class="support" aria-label="Support tools">
          <div class="support-dock">
            <button class="rescue-pill" id="rescueTrigger" type="button" aria-expanded="false" aria-controls="rescueSheet">
              Rescue
            </button>
          </div>
          <div class="support-ribbon" id="supportRibbon" aria-hidden="true">
            <div class="ribbon-handle" aria-hidden="true"></div>
            <div class="calm-tools">
              <button class="toggle" data-toggle="audio" type="button" aria-pressed="false">🎧</button>
              <button class="toggle" data-toggle="silence" type="button" aria-pressed="false">🔕</button>
              <button class="toggle" data-toggle="timer" type="button" aria-pressed="false">⏱</button>
            </div>
          </div>
          <div class="rescue-sheet" id="rescueSheet" role="dialog" aria-modal="true" aria-hidden="true">
            <header class="rescue-head">
              <h3>Rescue Modes</h3>
              <button type="button" id="rescueClose" aria-label="Close rescue sheet">✕</button>
            </header>
            <div class="rescue-tabs" role="tablist">
              <button class="rescue-tab active" data-tab="defuse" role="tab" aria-selected="true" type="button">Defuse</button>
              <button class="rescue-tab" data-tab="worst" role="tab" aria-selected="false" type="button">Worst Day</button>
              <button class="rescue-tab" data-tab="melt" role="tab" aria-selected="false" type="button">Meltdown</button>
            </div>
            <div class="rescue-body" id="rescueBody">
              Easy breathing reset · Inhale for 4, hold for 2, exhale for 6. Repeat 5 times.
            </div>
          </div>
        </section>
        <section class="focus-corridor" aria-live="polite">
          <div class="focus-card-shell">
            <div class="focus-card" id="focusCard">
              <span class="slot" id="focusSlot">Now</span>
              <h2 id="focusTitle">Draft quick client update</h2>
              <div class="focus-meta" id="focusMeta">
                <span>5 min slice</span>
                <span>Energy · Light</span>
                <span>Deadline 3h</span>
              </div>
            </div>
          </div>
          <div class="focus-alt-chips" id="altChips"></div>
          <div class="focus-tools-row">
            <button type="button" data-action="refresh">Refresh</button>
            <button type="button" data-action="adjust">Adjust</button>
            <button type="button" data-action="stuck">I'm stuck</button>
          </div>
          <div class="focus-inline-panel" id="chipPanel" aria-live="polite"></div>
        </section>
        <section class="dashboards">
          <div class="accordion open" data-accordion="today">
            <div class="accordion-header" role="button" tabindex="0">
              <div>Due Today</div>
              <span id="todaySummary">1 ready • est 22 min</span>
            </div>
            <div class="accordion-body">
              <div class="task-row">
                <strong>Prep slides for sync</strong>
                <button type="button" data-quick="start">Start</button>
              </div>
              <div class="task-row">
                <strong>Upload receipts</strong>
                <button type="button" data-quick="done">Mark done</button>
              </div>
            </div>
          </div>
          <div class="accordion" data-accordion="all">
            <div class="accordion-header" role="button" tabindex="0">
              <div>All Tasks</div>
              <span id="allSummary">56 active • 69 total</span>
            </div>
            <div class="accordion-body">
              <div class="task-row">
                <strong>Write outreach email batch</strong>
                <button type="button" data-quick="start">Start</button>
              </div>
              <div class="task-row">
                <strong>Book therapy follow-up</strong>
                <button type="button" data-quick="done">Mark done</button>
              </div>
              <div class="task-row add-new">
                <button type="button" id="accordionAdd">Add Task</button>
              </div>
            </div>
          </div>
        </section>
      </main>
      <footer class="bottom-area" aria-label="Navigation and quick capture">
        <div class="capture-strip" id="captureStrip" aria-hidden="true">
          <input type="text" id="quickTask" placeholder="Type a task and release" />
          <button type="button" id="saveTask">Save</button>
        </div>
        <div class="smart-nudge" id="smartNudge">
          <span>Nice work! Want another 2-minute step?</span>
          <div>
            <button type="button" id="nudgeLater">Remind me later</button>
            <button type="button" id="nudgeGo">Let's go</button>
          </div>
        </div>
        <nav class="bottom-nav" role="navigation" aria-label="Primary">
          <button class="nav-item" data-nav="home" type="button" aria-pressed="true">
            <span class="icon">🏠</span>
            Home
          </button>
          <button class="nav-item" data-nav="plan" type="button" aria-pressed="false">
            <span class="icon">📅</span>
            Plan
          </button>
          <button class="capture-trigger" id="captureTrigger" type="button" aria-expanded="false" aria-controls="captureStrip">+</button>
          <button class="nav-item" data-nav="wins" type="button" aria-pressed="false">
            <span class="icon">⭐</span>
            Wins
          </button>
          <button class="nav-item" data-nav="settings" type="button" aria-pressed="false">
            <span class="icon">⚙️</span>
            Settings
          </button>
        </nav>
      </footer>
    </div>
    <script>
      const appShell = document.getElementById("appShell");
      const corridorScrim = document.getElementById("corridorScrim") ?? (() => {
        const scrim = document.createElement("div");
        scrim.id = "corridorScrim";
        scrim.className = "corridor-scrim";
        scrim.setAttribute("aria-hidden", "true");
        appShell.appendChild(scrim);
        return scrim;
      })();
      const sprintBar = document.getElementById("sprintBar");
      const sprintLabel = document.getElementById("sprintLabel");
      const sprintMetrics = document.getElementById("sprintMetrics");
      const captureTrigger = document.getElementById("captureTrigger");
      const captureStrip = document.getElementById("captureStrip");
      const saveTask = document.getElementById("saveTask");
      const quickTask = document.getElementById("quickTask");
      const smartNudge = document.getElementById("smartNudge");
      const nudgeLater = document.getElementById("nudgeLater");
      const nudgeGo = document.getElementById("nudgeGo");
      const supportRibbon = document.getElementById("supportRibbon");
      const rescueTrigger = document.getElementById("rescueTrigger");
      const rescueSheet = document.getElementById("rescueSheet");
      const rescueClose = document.getElementById("rescueClose");
      const rescueBody = document.getElementById("rescueBody");
      const rescueTabs = Array.from(document.querySelectorAll(".rescue-sheet .rescue-tab"));
      const ribbonToggles = Array.from(document.querySelectorAll(".support-ribbon .toggle"));
      const focusCard = document.getElementById("focusCard");
      const focusSlot = document.getElementById("focusSlot");
      const focusTitle = document.getElementById("focusTitle");
      const focusMeta = document.getElementById("focusMeta");
      const altChips = document.getElementById("altChips");
      const chipPanel = document.getElementById("chipPanel");
      const accordionHeaders = document.querySelectorAll(".accordion-header");
      const accordionAdd = document.getElementById("accordionAdd");
      const navItems = Array.from(document.querySelectorAll(".bottom-nav .nav-item"));

      chipPanel.dataset.active = "";

      if (navItems.length) {
        navItems[0].classList.add("active");
      }

      navItems.forEach((item) => {
        item.addEventListener("click", () => {
          navItems.forEach((nav) => {
            nav.classList.remove("active");
            nav.setAttribute("aria-pressed", "false");
          });
          item.classList.add("active");
          item.setAttribute("aria-pressed", "true");
          vibrate(8);
          console.info(`Navigate: ${item.dataset.nav}`);
        });
      });

      const sprintDuration = 5 * 60;
      let sprintState = "idle";
      let sprintTimer = null;
      let sprintRemaining = sprintDuration;
      let streakCount = 5;
      let voiceTimer = null;
      let voiceActive = false;
      let nextNotification = null;

      const encouragements = [
        "Micro-wins add up",
        "You're steering the flow",
        "Just surf the next minute",
        "Stay with the motion"
      ];

      const focusQueue = [
        {
          title: "Draft quick client update",
          meta: ["5 min slice", "Energy · Light", "Deadline 3h"],
          slot: "Now"
        },
        {
          title: "Sort inbox to zero",
          meta: ["7 emails", "Mood · Neutral", "Reward: playlist"],
          slot: "Next"
        },
        {
          title: "Outline sprint retro",
          meta: ["1 block", "Energy · Medium", "Due tomorrow"],
          slot: "Later"
        },
        {
          title: "Prep meeting questions",
          meta: ["Focus 8 min", "Energy · High", "Share with team"],
          slot: "Later"
        }
      ];

      const altOptions = ["Tidy desk", "Refill water", "Stretch reset", "Inbox 5" ];
      let focusIndex = 0;

      function vibrate(duration = 15) {
        if (window.navigator?.vibrate) {
          window.navigator.vibrate(duration);
        }
      }

      function formatTime(seconds) {
        const m = String(Math.floor(seconds / 60)).padStart(2, "0");
        const s = String(seconds % 60).padStart(2, "0");
        return `${m}:${s}`;
      }

      function updateSprintMetrics() {
        const elapsed = sprintDuration - sprintRemaining;
        const metrics = [
          `Elapsed ${formatTime(elapsed)}`,
          `Streak · ${streakCount} days`,
          encouragements[(elapsed / 15) % encouragements.length | 0]
        ];
        sprintMetrics.querySelectorAll("span").forEach((node, index) => {
          node.textContent = metrics[index] ?? "";
        });
      }

      function stopSprint(options = {}) {
        const { restartLabel = "Start 5-min" } = options;
        if (sprintTimer) {
          clearInterval(sprintTimer);
          sprintTimer = null;
        }
        sprintState = "idle";
        sprintBar.classList.remove("active", "complete", "glow");
        sprintRemaining = sprintDuration;
        sprintLabel.textContent = restartLabel;
        updateSprintMetrics();
      }

      function completeSprint() {
        sprintState = "complete";
        sprintBar.classList.remove("active");
        sprintBar.classList.add("complete", "glow");
        sprintLabel.textContent = "Sprint done – nice work!";
        sprintMetrics.querySelectorAll("span")[0].textContent = "Elapsed 05:00";
        sprintMetrics.querySelectorAll("span")[1].textContent = `Streak · ${++streakCount} days`;
        sprintMetrics.querySelectorAll("span")[2].textContent = "Tap to start again";
        vibrate(30);
        const confetti = document.createElement("div");
        confetti.className = "confetti";
        sprintBar.appendChild(confetti);
        setTimeout(() => {
          confetti.remove();
        }, 650);
        showNudge();
        setTimeout(() => {
          stopSprint({ restartLabel: "Start again" });
        }, 1600);
      }

      function tickSprint() {
        if (sprintRemaining <= 0) {
          clearInterval(sprintTimer);
          sprintTimer = null;
          completeSprint();
          return;
        }
        sprintRemaining -= 1;
        updateSprintMetrics();
      }

      sprintBar.addEventListener("click", () => {
        if (sprintState === "idle") {
          sprintState = "active";
          sprintBar.classList.add("active");
          sprintLabel.textContent = "Sprint in motion";
          vibrate(20);
          sprintRemaining = sprintDuration;
          updateSprintMetrics();
          if (sprintTimer) {
            clearInterval(sprintTimer);
          }
          sprintTimer = setInterval(tickSprint, 1000);
        } else if (sprintState === "active") {
          vibrate(18);
          stopSprint();
        } else if (sprintState === "complete") {
          vibrate(20);
          stopSprint();
        }
      });

      function showNudge(delay = 400) {
        setTimeout(() => {
          smartNudge.classList.add("visible");
        }, delay);
      }

      function hideNudge() {
        smartNudge.classList.remove("visible");
      }

      nudgeGo.addEventListener("click", () => {
        hideNudge();
        vibrate(15);
        focusIndex = Math.min(focusIndex + 1, focusQueue.length - 1);
        updateFocusCard();
        if (sprintState === "idle") {
          sprintBar.click();
        }
      });

      nudgeLater.addEventListener("click", () => {
        hideNudge();
        vibrate(10);
        if (nextNotification) {
          clearTimeout(nextNotification);
        }
        nextNotification = setTimeout(() => {
          console.info("Silent notification: Ready for the next micro-step");
        }, 7 * 60 * 1000);
      });

      const rescueMessages = {
        defuse: "Easy breathing reset · Inhale for 4, hold for 2, exhale for 6. Repeat 5 times.",
        worst: "Worst Day Protocol · Text your anchor + hydrate. You've bounced back before.",
        melt: "Meltdown plan · Dim lights, weighted blanket, countdown from 30 together."
      };

      function openRibbon() {
        closeRescueSheet();
        closeCapture({ resetInput: false });
        supportRibbon.classList.add("visible");
        supportRibbon.setAttribute("aria-hidden", "false");
        highlightTopLayer();
      }

      function closeRibbon() {
        supportRibbon.classList.remove("visible");
        supportRibbon.setAttribute("aria-hidden", "true");
        highlightTopLayer();
      }

      function showScrim(reason) {
        corridorScrim.dataset.active = reason;
        corridorScrim.classList.add("visible");
        corridorScrim.setAttribute("aria-hidden", "false");
      }

      function hideScrim(reason) {
        if (!reason || corridorScrim.dataset.active === reason) {
          corridorScrim.classList.remove("visible");
          corridorScrim.setAttribute("aria-hidden", "true");
          delete corridorScrim.dataset.active;
        }
      }

      function openRescueSheet() {
        closeCapture({ resetInput: false });
        closeRibbon();
        rescueSheet.classList.add("open");
        rescueSheet.setAttribute("aria-hidden", "false");
        rescueTrigger.setAttribute("aria-expanded", "true");
        showScrim("rescue");
        vibrate(18);
        requestAnimationFrame(() => {
          rescueTabs[0]?.focus();
        });
        highlightTopLayer();
      }

      function closeRescueSheet() {
        if (!rescueSheet.classList.contains("open")) return;
        rescueSheet.classList.remove("open");
        rescueSheet.setAttribute("aria-hidden", "true");
        rescueTrigger.setAttribute("aria-expanded", "false");
        hideScrim("rescue");
        rescueTrigger.focus();
        highlightTopLayer();
      }

      let rescuePointerStartY = null;
      let rescueGestureHandled = false;

      rescueTrigger.addEventListener("pointerdown", (event) => {
        rescuePointerStartY = event.clientY ?? event.touches?.[0]?.clientY ?? null;
        rescueGestureHandled = false;
      });

      rescueTrigger.addEventListener("pointerup", (event) => {
        if (rescuePointerStartY == null) return;
        const endY = event.clientY ?? event.changedTouches?.[0]?.clientY ?? rescuePointerStartY;
        const delta = rescuePointerStartY - endY;
        if (delta > 24) {
          openRibbon();
          rescueGestureHandled = true;
          vibrate(12);
        } else if (delta < -24 && supportRibbon.classList.contains("visible")) {
          closeRibbon();
          rescueGestureHandled = true;
          vibrate(10);
        }
        rescuePointerStartY = null;
      });

      rescueTrigger.addEventListener("pointercancel", () => {
        rescuePointerStartY = null;
      });

      rescueTrigger.addEventListener("click", (event) => {
        if (rescueGestureHandled) {
          rescueGestureHandled = false;
          return;
        }
        if (rescueSheet.classList.contains("open")) {
          closeRescueSheet();
        } else {
          openRescueSheet();
        }
      });

      rescueTrigger.addEventListener("keydown", (event) => {
        if (event.key === "ArrowUp") {
          event.preventDefault();
          openRibbon();
        } else if (event.key === "ArrowDown") {
          event.preventDefault();
          closeRibbon();
        }
      });

      rescueClose.addEventListener("click", () => {
        closeRescueSheet();
      });

      corridorScrim.addEventListener("click", () => {
        closeRescueSheet();
        closeRibbon();
        closeCapture({ resetInput: false });
      });

      rescueTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const tabName = tab.dataset.tab;
          rescueTabs.forEach((node) => {
            node.classList.toggle("active", node === tab);
            node.setAttribute("aria-selected", node === tab ? "true" : "false");
          });
          rescueBody.textContent = rescueMessages[tabName];
          vibrate(8);
        });
      });

      ribbonToggles.forEach((toggle) => {
        toggle.addEventListener("click", () => {
          const pressed = toggle.getAttribute("aria-pressed") === "true";
          toggle.setAttribute("aria-pressed", String(!pressed));
          vibrate(6);
        });
      });

      function updateFocusCard() {
        const item = focusQueue[focusIndex % focusQueue.length];
        focusSlot.textContent = item.slot ?? "Now";
        focusTitle.textContent = item.title;
        focusMeta.innerHTML = "";
        item.meta.forEach((detail) => {
          const span = document.createElement("span");
          span.textContent = detail;
          focusMeta.appendChild(span);
        });
        focusCard.classList.remove("swipe-left", "swipe-right");
        updateAltChips();
        chipPanel.classList.remove("active");
        chipPanel.textContent = "";
        chipPanel.dataset.active = "";
      }

      function updateAltChips() {
        altChips.innerHTML = "";
        altOptions.slice(0, 3).forEach((label) => {
          const chip = document.createElement("button");
          chip.className = "focus-chip";
          chip.type = "button";
          chip.textContent = label;
          chip.addEventListener("click", () => {
            vibrate(8);
            smartNudge.classList.add("visible");
          });
          altChips.appendChild(chip);
        });
      }

      const chipMessages = {
        refresh: "Surface the next best micro-move to keep momentum warm.",
        adjust: "Lighten the scope or swap to a friendlier slice for right now.",
        stuck: "SOS kit: text your anchor, sip water, breathe for 30 seconds together."
      };

      document.querySelectorAll(".focus-tools-row button").forEach((button) => {
        button.addEventListener("click", () => {
          const action = button.dataset.action;
          if (chipPanel.dataset.active === action) {
            chipPanel.dataset.active = "";
            chipPanel.textContent = "";
            chipPanel.classList.remove("active");
            vibrate(6);
            return;
          }
          chipPanel.dataset.active = action;
          chipPanel.textContent = chipMessages[action] ?? "Micro-coaching coming soon.";
          chipPanel.classList.add("active");
          vibrate(8);
        });
      });

      let startX = null;

      function handlePointerStart(event) {
        startX = event.clientX ?? event.touches?.[0]?.clientX;
      }

      function handlePointerEnd(event) {
        const endX = event.clientX ?? event.changedTouches?.[0]?.clientX;
        if (startX == null || endX == null) return;
        const delta = endX - startX;
        if (Math.abs(delta) < 40) {
          return;
        }
        if (delta < 0 && focusIndex < focusQueue.length - 1) {
          focusCard.classList.add("swipe-left");
          focusIndex += 1;
          setTimeout(updateFocusCard, 180);
          vibrate(15);
        } else if (delta > 0 && focusIndex > 0) {
          focusCard.classList.add("swipe-right");
          focusIndex -= 1;
          setTimeout(updateFocusCard, 180);
          vibrate(15);
        }
        startX = null;
      }

      focusCard.addEventListener("pointerdown", handlePointerStart);
      focusCard.addEventListener("pointerup", handlePointerEnd);
      focusCard.addEventListener("touchstart", handlePointerStart);
      focusCard.addEventListener("touchend", handlePointerEnd);

      accordionHeaders.forEach((header) => {
        header.addEventListener("click", () => toggleAccordion(header));
        header.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            toggleAccordion(header);
          }
        });
      });

      function toggleAccordion(header) {
        const parent = header.closest(".accordion");
        const isOpen = parent.classList.contains("open");
        document.querySelectorAll(".accordion").forEach((acc) => acc.classList.remove("open"));
        if (!isOpen) {
          parent.classList.add("open");
        }
      }

      function openCapture() {
        closeRescueSheet();
        closeRibbon();
        if (!captureStrip.classList.contains("open")) {
          captureStrip.classList.add("open");
          captureStrip.setAttribute("aria-hidden", "false");
          captureTrigger.setAttribute("aria-expanded", "true");
          appShell.classList.add("capture-open");
        }
        requestAnimationFrame(() => {
          try {
            quickTask.focus({ preventScroll: true });
          } catch (error) {
            quickTask.focus();
          }
        });
        highlightTopLayer();
      }

      function closeCapture(options = {}) {
        if (!captureStrip.classList.contains("open")) return;
        const { resetInput = true } = options;
        captureStrip.classList.remove("open");
        captureStrip.setAttribute("aria-hidden", "true");
        captureTrigger.setAttribute("aria-expanded", "false");
        appShell.classList.remove("capture-open");
        if (resetInput) {
          quickTask.value = "";
        }
        quickTask.dataset.voice = "";
        highlightTopLayer();
      }

      captureTrigger.addEventListener("click", () => {
        openCapture();
        vibrate(10);
      });

      saveTask.addEventListener("click", () => {
        if (!quickTask.value.trim()) {
          quickTask.placeholder = "Try a short verb + noun";
          return;
        }
        vibrate(30);
        closeCapture();
      });

      accordionAdd.addEventListener("click", () => {
        openCapture();
        vibrate(12);
      });

      let swipeStartY = null;
      document.addEventListener("pointerdown", (event) => {
        const target = event.target;
        if (supportRibbon.classList.contains("visible") && !supportRibbon.contains(target) && target !== rescueTrigger) {
          closeRibbon();
        }
        if (rescueSheet.classList.contains("open") && !target.closest(".rescue-sheet") && target !== rescueTrigger) {
          closeRescueSheet();
        }
        if (captureStrip.classList.contains("open") && !captureStrip.contains(target) && target !== captureTrigger) {
          closeCapture({ resetInput: false });
        }
        if (event.clientY > window.innerHeight - 120) {
          swipeStartY = event.clientY;
        }
        highlightTopLayer();
      });

      document.addEventListener("pointerup", (event) => {
        if (swipeStartY !== null) {
          const delta = swipeStartY - event.clientY;
          if (delta > 24) {
            openCapture();
          }
        }
        swipeStartY = null;
      });

      captureTrigger.addEventListener("pointerdown", () => {
        voiceTimer = setTimeout(() => {
          voiceActive = true;
          quickTask.value = "Listening...";
          quickTask.dataset.voice = "active";
          vibrate(40);
          setTimeout(() => {
            if (quickTask.dataset.voice === "active") {
              quickTask.value = "Voice note: brainstorm project";
              quickTask.dataset.voice = "";
            }
          }, 2600);
        }, 500);
      });

      captureTrigger.addEventListener("pointerup", () => {
        clearTimeout(voiceTimer);
        if (voiceActive) {
          openCapture();
          voiceActive = false;
          quickTask.dataset.voice = "";
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeRescueSheet();
          closeRibbon();
          closeCapture({ resetInput: false });
        }
      });

      const debugOutline = document.createElement("div");
      debugOutline.id = "zDebugOutline";
      document.body.appendChild(debugOutline);

      function highlightTopLayer() {
        const x = window.innerWidth / 2;
        const y = window.innerHeight / 2;
        const elements = document.elementsFromPoint(x, y) ?? [];
        const topElement = elements.find((el) => el !== debugOutline && el !== document.body && el !== document.documentElement);
        if (!topElement) {
          debugOutline.style.opacity = "0";
          return;
        }
        const rect = topElement.getBoundingClientRect();
        debugOutline.style.opacity = "1";
        debugOutline.style.left = `${rect.left}px`;
        debugOutline.style.top = `${rect.top}px`;
        debugOutline.style.width = `${rect.width}px`;
        debugOutline.style.height = `${rect.height}px`;
        clearTimeout(debugOutline._hideTimer);
        debugOutline._hideTimer = setTimeout(() => {
          debugOutline.style.opacity = "0";
        }, 1600);
      }

      highlightTopLayer();
      window.addEventListener("resize", () => {
        highlightTopLayer();
      });
      window.__corridorHighlightLayer = highlightTopLayer;

      updateFocusCard();
      updateSprintMetrics();
    </script>
  </body>
</html>
