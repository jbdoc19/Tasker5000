<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Focus</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h3 { color: #fff; }
    .hidden { display: none; }
    label { display: block; margin-top: 0.5rem; }
    input[type="text"], select, input[type="date"] {
      background: #222; color: #eee; border: 1px solid #555;
      padding: 0.5rem; width: 100%;
    }
    button {
      background: #333; color: #fff; border: none; padding: 0.6rem 1rem;
      margin: 0.5rem 0.25rem; cursor: pointer; border-radius: 4px;
    }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    .peek { background: #222; margin-top: 1rem; padding: 1rem; border-radius: 6px; max-width: 600px; }
    .peek summary { cursor: pointer; }
    .task { margin: 0.25rem 0; }
    .score { font-size: 0.8rem; color: #ccc; }
    .focus { font-size: 1.5rem; margin: 1rem 0; }
    [aria-live] { outline: none; }
  </style>
</head>
<body>
  <h1>ğŸ¯ Task Focus</h1>

  <!-- Task entry form -->
  <section id="capture">
    <label>Task Name <input id="name" type="text" /></label>
    <label>Importance (1â€“5) <select id="importance"></select></label>
    <label>Urgency (1â€“5) <select id="urgency"></select></label>
    <label>Dopamine â€“ Novelty (1â€“5) <select id="novelty"></select></label>
    <label>Dopamine â€“ Interest (1â€“5) <select id="interest"></select></label>
    <label>Dopamine â€“ External Pressure
      <select id="externalPressure">
        <option value="" disabled selected>â¬‡ï¸ Select external pressure</option>
        <option value="0">No one is waiting</option>
        <option value="2">Soft deadline</option>
        <option value="3">Peer is waiting on me</option>
        <option value="5">Boss is watching</option>
        <option value="5">Patient emergency</option>
      </select>
    </label>
    <label>Time to Start (1â€“5) <select id="timeToStart"></select></label>
    <label>Difficulty (1â€“5) <select id="difficulty"></select></label>
    <label>Optional Due Date <input type="date" id="dueDate" /></label>
    <div>
      <button onclick="addTask()">Add Task</button>
      <button onclick="saveAsTemplate()">Add as Template</button>
      <button onclick="startFocus()" id="startBtn" disabled>Get started</button>
      <button onclick="reset()">Reset</button>
    </div>
    <div id="templateSection" style="margin-top:1rem;">
      <h3>Templates</h3>
      <div id="templateButtons"></div>
    </div>
    <details class="peek">
      <summary>ğŸ” Peek at tasks</summary>
      <div id="taskList"></div>
    </details>
    <div id="dueTodaySection" style="margin-top:1rem;">
      <h3>ğŸ—‚ï¸ Charts Due Today</h3>
      <div id="dueTodayList"></div>
    </div>
  </section>

  <!-- Focus mode -->
  <section id="focus" class="hidden">
    <div class="focus" tabindex="0" aria-live="polite"></div>
    <div class="score" id="scoreView"></div>
    <div id="subTaskView"></div>
    <div>
      <button onclick="completeTask()">Task complete</button>
      <button onclick="backToCapture()">Back to capture</button>
    </div>
  </section>

  <script>
  // Simple DOM helper
  const $ = id => document.getElementById(id);

  // Populate dropdowns 1â€“5
  const scales = ["importance","urgency","novelty","interest","timeToStart","difficulty"];
  scales.forEach(id => {
    const sel = $(id);
    for (let i = 1; i <= 5; i++) {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      sel.appendChild(opt);
    }
  });

  // Task data
  let tasks = [];
  let templates = [];
  let focusQueue = [];

  // Priority formula; if subâ€‘tasks exist, average remaining subâ€‘task priorities
  function computePriority(t) {
    if (Array.isArray(t.subTasks) && t.subTasks.length) {
      const remaining = t.subTasks.filter(s => !s.completed);
      if (remaining.length === 0) return 0;
      const total = remaining.reduce((sum,s) => sum + s.priority, 0);
      return total / remaining.length;
    }
    const dopamine = t.novelty + t.interest;
    const pressure = t.externalPressure;
    const friction = (6 - t.timeToStart) + (6 - t.difficulty);
    return (t.importance * 2)
         + (t.urgency    * 2)
         + (dopamine     * 2)
         + (pressure     * 5)
         + (friction     * 1.5);
  }

  // Save tasks to localStorage
  function persist() {
    localStorage.setItem("tasks", JSON.stringify(tasks));
  }

  // Add a new task
  function addTask() {
    const name = $("name").value.trim();
    if (!name) return;
    const task = {
      id: Date.now().toString(),
      name,
      importance: +$("importance").value,
      urgency: +$("urgency").value,
      novelty: +$("novelty").value,
      interest: +$("interest").value,
      externalPressure: +$("externalPressure").value,
      timeToStart: +$("timeToStart").value,
      difficulty: +$("difficulty").value,
      dueDate: $("dueDate").value || null,
      completed: false,
      createdAt: new Date().toISOString(),
      addedAt: new Date().toISOString(),
      subTasks: []
    };
    task.priority = computePriority(task);
    tasks.push(task);
    persist();
    $("name").value = "";
    updateUI();
  }

  // Main UI refresh
  function updateUI() {
    const taskList = $("taskList");
    taskList.innerHTML = "";
    const remaining = tasks.filter(t => !t.completed);
    $("startBtn").disabled = remaining.length === 0;
    tasks.sort((a, b) => b.priority - a.priority);

    tasks.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "task";
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      const info = document.createElement("span");
      info.textContent = `${t.name} ${t.completed ? "(âœ“)" : ""} â€” ${t.priority.toFixed(1)}`;
      const delBtn = document.createElement("button");
      delBtn.textContent = "ğŸ—‘ï¸";
      delBtn.onclick = () => {
        if (!confirm("Delete this task?")) return;
        tasks.splice(i, 1);
        persist();
        updateUI();
      };
      row.appendChild(info);
      row.appendChild(delBtn);
      div.appendChild(row);

      if (t.addedAt) {
        const ts = document.createElement("div");
        ts.className = "score";
        ts.textContent = `Added: ${new Date(t.addedAt).toLocaleString()}`;
        div.appendChild(ts);
      }
      if (t.dueDate) {
        const dd = document.createElement("div");
        dd.className = "score";
        dd.textContent = `Due: ${t.dueDate}`;
        div.appendChild(dd);
      }

      // subâ€‘task progress and list
      if (t.subTasks && t.subTasks.length > 0) {
        const completedCount = t.subTasks.filter(s => s.completed).length;
        const progress = document.createElement("div");
        progress.className = "score";
        progress.textContent = `${completedCount}/${t.subTasks.length} steps done`;
        div.appendChild(progress);

        t.subTasks.forEach((sub, subIndex) => {
          const subRow = document.createElement("div");
          subRow.style.display = "flex";
          subRow.style.alignItems = "center";
          subRow.style.marginLeft = "1rem";
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.checked = sub.completed;
          chk.onchange = () => completeSubTask(i, subIndex);
          const label = document.createElement("span");
          label.textContent = sub.name;
          label.style.marginLeft = "0.25rem";
          subRow.appendChild(chk);
          subRow.appendChild(label);
          div.appendChild(subRow);
        });
      }

      // button to add a subâ€‘task
      const addSubBtn = document.createElement("button");
      addSubBtn.textContent = "â• Step";
      addSubBtn.style.marginTop = "0.25rem";
      addSubBtn.onclick = () => addSubTask(i);
      div.appendChild(addSubBtn);

      taskList.appendChild(div);
    });

    // tasks due today
    const dueTodayList = $("dueTodayList");
    dueTodayList.innerHTML = "";
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const today = now.toISOString().split("T")[0];

    tasks.forEach((task, idx) => {
      if (task.dueDate === today && !task.completed) {
        const wrap = document.createElement("div");
        wrap.textContent = `${task.name} â€” due today`;

        if (task.subTasks && task.subTasks.length) {
          const completedCount = task.subTasks.filter(s => s.completed).length;
          const progress = document.createElement("div");
          progress.className = "score";
          progress.textContent = `${completedCount}/${task.subTasks.length} steps done`;
          wrap.appendChild(progress);

          task.subTasks.forEach((sub, subIndex) => {
            const subRow = document.createElement("div");
            subRow.style.display = "flex";
            subRow.style.alignItems = "center";
            subRow.style.marginLeft = "1rem";
            const chk = document.createElement("input");
            chk.type = "checkbox";
            chk.checked = sub.completed;
            chk.onchange = () => completeSubTask(idx, subIndex);
            const label = document.createElement("span");
            label.textContent = sub.name;
            label.style.marginLeft = "0.25rem";
            subRow.appendChild(chk);
            subRow.appendChild(label);
            wrap.appendChild(subRow);
          });
        }

        const addSubBtn = document.createElement("button");
        addSubBtn.textContent = "â• Step";
        addSubBtn.style.marginTop = "0.25rem";
        addSubBtn.onclick = () => addSubTask(idx);
        wrap.appendChild(addSubBtn);

        dueTodayList.appendChild(wrap);
      }
    });
  }

  // Focus mode
  function startFocus() {
    $("capture").classList.add("hidden");
    $("focus").classList.remove("hidden");
    // clone remaining tasks sorted by priority
    focusQueue = tasks.filter(t => !t.completed).sort((a,b) => b.priority - a.priority);
    showNextTask();
  }

  function showNextTask() {
    const display = document.querySelector(".focus");
    const scoreView = $("scoreView");
    const subTaskView = $("subTaskView");
    if (focusQueue.length === 0) {
      display.textContent = "âœ… All tasks complete!";
      scoreView.textContent = "";
      subTaskView.innerHTML = "";
      return;
    }
    const current = focusQueue[0];
    display.textContent = current.name;
    scoreView.textContent = `Score: ${current.priority.toFixed(1)}`;
    display.focus();

    // find index of current task in tasks array
    const idx = tasks.findIndex(t => t.id === current.id);

    // render subâ€‘tasks in focus view
    subTaskView.innerHTML = "";
    if (current.subTasks && current.subTasks.length > 0) {
      current.subTasks.forEach((sub, subIndex) => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.checked = sub.completed;
        chk.onchange = () => completeSubTask(idx, subIndex);
        const label = document.createElement("span");
        label.textContent = sub.name;
        label.style.marginLeft = "0.25rem";
        row.appendChild(chk);
        row.appendChild(label);
        subTaskView.appendChild(row);
      });
    } else {
      subTaskView.textContent = "No subâ€‘tasks for this task.";
    }
  }

  function completeTask() {
    if (!focusQueue.length) return;
    focusQueue[0].completed = true;
    persist();
    updateUI();
    focusQueue.shift();
    showNextTask();
  }

  function backToCapture() {
    $("focus").classList.add("hidden");
    $("capture").classList.remove("hidden");
    updateUI();
  }

  // Reset all tasks
  function reset() {
    if (!confirm("Clear all tasks?")) return;
    tasks = [];
    localStorage.removeItem("tasks");
    updateUI();
  }

  // Template functions
  function saveAsTemplate() {
    const name = $("name").value.trim();
    if (!name) return alert("Task name is required");
    const template = {
      name,
      importance: +$("importance").value,
      urgency: +$("urgency").value,
      novelty: +$("novelty").value,
      interest: +$("interest").value,
      externalPressure: +$("externalPressure").value,
      timeToStart: +$("timeToStart").value,
      difficulty: +$("difficulty").value
    };
    templates.push(template);
    localStorage.setItem("templates", JSON.stringify(templates));
    renderTemplates();
  }

  function renderTemplates() {
    const container = $("templateButtons");
    container.innerHTML = "";
    templates.forEach((t, i) => {
      const wrapper = document.createElement("div");
      const useBtn = document.createElement("button");
      useBtn.textContent = `ğŸ“‹ ${t.name}`;
      useBtn.onclick = () => {
        $("name").value = t.name;
        $("importance").value = t.importance;
        $("urgency").value = t.urgency;
        $("novelty").value = t.novelty;
        $("interest").value = t.interest;
        $("externalPressure").value = t.externalPressure;
        $("timeToStart").value = t.timeToStart;
        $("difficulty").value = t.difficulty;
      };
      const editBtn = document.createElement("button");
      editBtn.textContent = "âœï¸ Edit";
      editBtn.onclick = () => {
        const newName = prompt("Edit task name:", t.name);
        if (!newName) return;
        t.name = newName;
        localStorage.setItem("templates", JSON.stringify(templates));
        renderTemplates();
      };
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "ğŸ—‘ï¸ Delete";
      deleteBtn.onclick = () => {
        if (!confirm("Delete this template?")) return;
        templates.splice(i, 1);
        localStorage.setItem("templates", JSON.stringify(templates));
        renderTemplates();
      };
      [useBtn, editBtn, deleteBtn].forEach(b => {
        b.style.marginRight = "0.3rem";
        b.style.fontSize = "0.9rem";
      });
      wrapper.appendChild(useBtn);
      wrapper.appendChild(editBtn);
      wrapper.appendChild(deleteBtn);
      container.appendChild(wrapper);
    });
  }

  // Subâ€‘task functions
  function addSubTask(taskIndex) {
    const name = prompt("Sub-task name?");
    if (!name) return;
    const trimmed = name.trim();
    if (!trimmed) return;
    const parent = tasks[taskIndex];
    if (!parent) return;
    if (!Array.isArray(parent.subTasks)) parent.subTasks = [];
    const basePriority = computePriority({ ...parent, subTasks: [] });
    const subTask = {
      id: Date.now().toString(),
      name: trimmed,
      completed: false,
      priority: basePriority
    };
    parent.subTasks.push(subTask);
    parent.priority = computePriority(parent);
    persist();
    updateUI();
  }

  function completeSubTask(taskIndex, subIndex) {
    const parent = tasks[taskIndex];
    if (!parent || !parent.subTasks) return;
    const subTask = parent.subTasks[subIndex];
    if (!subTask) return;
    subTask.completed = true;
    parent.priority = computePriority(parent);
    persist();
    updateUI();
  }

  // Initialize on load: restore tasks/templates from localStorage
  window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem("tasks");
    if (saved) tasks = JSON.parse(saved);
    const savedTemplates = localStorage.getItem("templates");
    if (savedTemplates) templates = JSON.parse(savedTemplates);
    renderTemplates();
    updateUI();
  });
  </script>
</body>
</html>
